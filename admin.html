<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <style>
    body{font-family:system-ui,Tahoma,Arial;background:#f6f7fb;margin:0;padding:18px}
    .wrap{max-width:1200px;margin:auto;display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:14px;box-shadow:0 8px 22px rgba(0,0,0,.06)}
    h1{margin:0 0 6px 0;font-size:22px}
    .sub{color:#666;margin-bottom:10px}
    button,input,textarea{padding:12px;border-radius:12px;border:1px solid #d7dbe6;font-size:15px}
    button{cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    textarea{width:100%;min-height:220px;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{font-weight:700}
    .btn-reset{background:#f3f4f6}
    .btn-start{background:#dcfce7}
    .btn-stop{background:#fee2e2}
    .ok{color:#16a34a;font-weight:800}
    .warn{color:#b45309;font-weight:800}
    .err{color:#dc2626;font-weight:800}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#444;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:right;font-size:14px}
    th{background:#fafafa}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;font-size:12px;text-decoration:none;color:#111}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <h1>ğŸ› Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Ø³Ø¨Ø§Ù‚ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† / 10 Ø£Ø³Ø¦Ù„Ø©)</h1>
        <div class="sub">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <b>ØªÙ†Ø¸ÙŠÙ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</b> â†’ <b>Ø§Ø³ØªÙŠØ±Ø§Ø¯ 10 Ø£Ø³Ø¦Ù„Ø©</b> â†’ <b>Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</b>. Ø¨Ø¹Ø¯Ù‡Ø§ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ ÙŠÙ…Ø´ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ.</div>
      </div>
      <a class="pill" href="./?v=999" target="_blank">ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</a>
    </div>

    <div class="grid" style="margin-top:10px">
      <button class="btn btn-reset" id="wipeBtn" type="button">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ (players/answers/questions)</button>
      <button class="btn" id="importBtn" type="button">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ 10 Ø£Ø³Ø¦Ù„Ø©</button>
    </div>

    <div style="margin-top:10px" class="grid">
      <button class="btn btn-start" id="startBtn" type="button">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ (120 Ø«Ø§Ù†ÙŠØ©)</button>
      <button class="btn btn-stop" id="stopBtn" type="button">â›” Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¨ÙƒØ±</button>
    </div>

    <div style="margin-top:10px" id="msg" class="warn">Ø¬Ø§Ù‡Ø²â€¦</div>
    <div id="dbg" class="mono" style="margin-top:6px"></div>
    <div id="err" class="mono err" style="margin-top:6px"></div>

    <hr style="margin:14px 0">

    <h2 style="margin:0 0 6px 0">ğŸ“¥ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (JSON)</h2>
    <div class="sub">Ù„Ø§Ø²Ù… ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙŠØ­ØªÙˆÙŠ: <b>text</b> + <b>options(4)</b> + <b>correctIndex(0..3)</b></div>
    <textarea id="qJson"></textarea>
  </div>

  <div class="card">
    <h1>ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (Live)</h1>
    <table>
      <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th></tr></thead>
      <tbody id="playersT"></tbody>
    </table>

    <hr style="margin:14px 0">

    <h1>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h1>
    <div class="sub">Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„ØµØ­ÙŠØ­ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø«Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø£Ù‚Ù„.</div>
    <table>
      <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµØ­ÙŠØ­</th><th>Ø§Ù„ÙˆÙ‚Øª (Ø«)</th><th>Ù…ÙƒØªÙ…Ù„</th></tr></thead>
      <tbody id="boardT"></tbody>
    </table>
  </div>

</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
    authDomain: "jawad-race.firebaseapp.com",
    projectId: "jawad-race",
    storageBucket: "jawad-race.firebasestorage.app",
    messagingSenderId: "677185572718",
    appId: "1:677185572718:web:91c4674236efce1d6efb7f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, collection, setDoc, updateDoc, getDoc, getDocs,
    query, orderBy, limit, serverTimestamp, onSnapshot, where,
    writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const raceRef      = doc(db, "race", "current");
  const questionsCol = collection(db, "questions");
  const playersCol   = collection(db, "players");
  const answersCol   = collection(db, "answers");

  const msgEl = document.getElementById("msg");
  const dbgEl = document.getElementById("dbg");
  const errEl = document.getElementById("err");
  const playersT = document.getElementById("playersT");
  const boardT   = document.getElementById("boardT");
  const qJsonEl  = document.getElementById("qJson");

  const say = (t, cls="warn") => { msgEl.className = cls; msgEl.textContent = t; };
  const setErr = (t="") => { errEl.textContent = t; };

  // Ù‚Ø§Ù„Ø¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ (10 Ø£Ø³Ø¦Ù„Ø©) â€” Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù†ØµÙˆØµ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØ¨ÙŠ
  qJsonEl.value = JSON.stringify([
    { text:"Ø£ÙŠÙ† ÙˆÙÙ„Ø¯ Ø§Ù„Ø¥Ù…Ø§Ù… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)ØŸ", options:["Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©","Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©","Ø§Ù„ÙƒÙˆÙØ©","Ø¨ØºØ¯Ø§Ø¯"], correctIndex:0 },
    { text:"Ù…Ù† Ù‡Ùˆ ÙˆØ§Ù„Ø¯ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)ØŸ", options:["Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ø¸Ù… (Ø¹)","Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø±Ø¶Ø§ (Ø¹)","Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù‡Ø§Ø¯ÙŠ (Ø¹)","Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„ØµØ§Ø¯Ù‚ (Ø¹)"], correctIndex:1 },
    { text:"Ù…Ø§ ÙƒÙ†ÙŠØ© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)ØŸ", options:["Ø£Ø¨Ùˆ Ø§Ù„Ø­Ø³Ù†","Ø£Ø¨Ùˆ Ø¬Ø¹ÙØ±","Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯","Ø£Ø¨Ùˆ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡"], correctIndex:1 },
    { text:"ÙÙŠ Ø£ÙŠ Ø¹Ù…Ø± ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ØªÙˆÙ„Ù‘Ù‰ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹) Ø§Ù„Ø¥Ù…Ø§Ù…Ø©ØŸ", options:["5 Ø³Ù†ÙˆØ§Øª","8 Ø³Ù†ÙˆØ§Øª","15 Ø³Ù†Ø©","20 Ø³Ù†Ø©"], correctIndex:1 },
    { text:"Ø£ÙŠÙ† Ø§Ø³ØªÙØ´Ù‡Ø¯ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)ØŸ", options:["Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©","Ù…ÙƒØ©","Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„ÙƒÙˆÙØ©"], correctIndex:2 },
    { text:"Ù…Ù† Ø£Ù„Ù‚Ø§Ø¨ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)ØŸ", options:["Ø§Ù„Ø¬ÙˆØ§Ø¯","Ø§Ù„Ø³Ø¬Ø§Ø¯","Ø§Ù„Ø¨Ø§Ù‚Ø±","Ø§Ù„ØµØ¯Ù‘ÙŠÙ‚"], correctIndex:0 },
    { text:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ", options:["2","3","4","5"], correctIndex:2 },
    { text:"Ù…Ø¯Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ØŸ", options:["60 Ø«Ø§Ù†ÙŠØ©","90 Ø«Ø§Ù†ÙŠØ©","120 Ø«Ø§Ù†ÙŠØ©","180 Ø«Ø§Ù†ÙŠØ©"], correctIndex:2 },
    { text:"Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ØŸ", options:["Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·","Ø§Ù„Ø³Ø±Ø¹Ø© ÙÙ‚Ø·","Ø§Ù„ØµØ­ÙŠØ­ Ø«Ù… Ø§Ù„ÙˆÙ‚Øª","Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø·"], correctIndex:2 },
    { text:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ", options:["5","10","15","20"], correctIndex:1 }
  ], null, 2);

  async function deleteAllIn(colRef, batchSize=200){
    const snap = await getDocs(query(colRef, limit(batchSize)));
    if(snap.empty) return;
    const batch = writeBatch(db);
    snap.docs.forEach(d=> batch.delete(d.ref));
    await batch.commit();
    if(snap.size === batchSize) await deleteAllIn(colRef, batchSize);
  }

  document.getElementById("wipeBtn").onclick = async()=>{
    setErr("");
    try{
      if(!confirm("ØªØ£ÙƒÙŠØ¯: Ø³ÙŠØªÙ… Ø­Ø°Ù questions + answers + players Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù…ÙˆØ§ÙÙ‚ØŸ")) return;
      await deleteAllIn(playersCol);
      await deleteAllIn(answersCol);
      await deleteAllIn(questionsCol);
      await setDoc(raceRef, {
        status:"waiting",
        raceId:null,
        durationSec:120,
        questionsOrder:[],
        startedAt:null,
        updatedAt: serverTimestamp()
      }, {merge:true});
      say("âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ù…Ù„","ok");
    }catch(e){
      say("âŒ ÙØ´Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ","err");
      setErr(e?.message||String(e));
    }
  };

  document.getElementById("importBtn").onclick = async()=>{
    setErr("");
    try{
      const arr = JSON.parse(qJsonEl.value || "[]");
      if(!Array.isArray(arr) || arr.length !== 10) throw new Error("Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ Ø¨Ø§Ù„Ø¶Ø¨Ø· 10 Ø£Ø³Ø¦Ù„Ø© ÙÙŠ JSON.");

      const batch = writeBatch(db);
      const ids = [];
      arr.forEach((q, i)=>{
        const id = `q${i+1}`;
        ids.push(id);

        const text = (q.text || "").trim();
        const options = Array.isArray(q.options) ? q.options.map(x=>String(x)) : [];
        const correctIndex = Number(q.correctIndex);

        if(!text) throw new Error(`Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${i+1} Ù†Ø§Ù‚Øµ text`);
        if(options.length !== 4) throw new Error(`Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${i+1} Ù„Ø§Ø²Ù… 4 Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø§Ù„Ø¶Ø¨Ø·`);
        if(!Number.isFinite(correctIndex) || correctIndex < 0 || correctIndex > 3) throw new Error(`Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${i+1} correctIndex Ù„Ø§Ø²Ù… 0..3`);

        batch.set(doc(db,"questions",id), {
          text,
          options,
          correctIndex,
          order: i+1,
          updatedAt: serverTimestamp(),
          createdAt: serverTimestamp(),
        }, { merge:true });
      });

      await batch.commit();

      await setDoc(raceRef, {
        status:"waiting",
        raceId:null,
        durationSec:120,
        questionsOrder: ids,
        startedAt:null,
        updatedAt: serverTimestamp()
      }, {merge:true});

      say("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ 10 Ø£Ø³Ø¦Ù„Ø© Ø¨ØµÙŠØºØ© ØµØ­ÙŠØ­Ø© (options Ù…Ø¶Ù…ÙˆÙ†Ø©)","ok");
    }catch(e){
      say("âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯","err");
      setErr(e?.message||String(e));
    }
  };

  document.getElementById("startBtn").onclick = async()=>{
    setErr("");
    try{
      const rs = await getDoc(raceRef);
      const r = rs.exists()? rs.data() : {};
      const order = Array.isArray(r.questionsOrder) ? r.questionsOrder : [];
      if(order.length !== 10) throw new Error("Ø§Ø³ØªÙˆØ±Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ù‹Ø§ (Ù„Ø§Ø²Ù… 10).");

      // raceId Ø¬Ø¯ÙŠØ¯ ÙŠÙ…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
      const raceId = String(Date.now());
      await setDoc(raceRef, {
        status:"running",
        raceId,
        durationSec:120,
        startedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, {merge:true});

      say("â–¶ï¸ Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø¨Ø§Ù‚ (120 Ø«Ø§Ù†ÙŠØ©)","ok");
    }catch(e){
      say("âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø¯Ø¡","err");
      setErr(e?.message||String(e));
    }
  };

  document.getElementById("stopBtn").onclick = async()=>{
    setErr("");
    try{
      await updateDoc(raceRef, { status:"finished", updatedAt: serverTimestamp() });
      say("â›” ØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙƒØ±","ok");
    }catch(e){
      say("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡","err");
      setErr(e?.message||String(e));
    }
  };

  // Debug
  onSnapshot(raceRef, (snap)=>{
    if(!snap.exists()){
      dbgEl.textContent = "race/current ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
      return;
    }
    const r = snap.data();
    dbgEl.textContent = `status=${r.status||"-"} | raceId=${r.raceId||"null"} | durationSec=${r.durationSec||120}`;
  });

  // Players (live)
  onSnapshot(query(playersCol, orderBy("updatedAt","desc"), limit(50)), (snap)=>{
    playersT.innerHTML="";
    let i=1;
    snap.forEach(d=>{
      const p=d.data();
      const t = p.updatedAt?.toDate ? p.updatedAt.toDate().toLocaleTimeString("ar-SA") : "";
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${i++}</td><td>${p.name||""}</td><td class="mono">${t}</td>`;
      playersT.appendChild(tr);
    });
  });

  // Leaderboard (raceId filter)
  let currentRaceId = null;
  onSnapshot(raceRef, async (snap)=>{
    if(!snap.exists()) return;
    const r = snap.data();
    const raceId = r.raceId || null;
    currentRaceId = raceId;

    // Ù„Ø§ Ù†Ø¹Ø±Ø¶ ØªØ±ØªÙŠØ¨ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙÙŠÙ‡ raceId
    boardT.innerHTML="";
    if(!raceId) return;

    onSnapshot(query(answersCol, where("raceId","==", raceId), orderBy("createdAt","asc"), limit(5000)), (asnap)=>{
      const agg = new Map(); // name -> {correct,timeMs,answeredCount}
      asnap.forEach(d=>{
        const a=d.data();
        const name=a.playerName||"â€”";
        if(!agg.has(name)) agg.set(name, {correct:0, timeMs:0, answeredCount:0});
        const row = agg.get(name);
        row.correct += a.isCorrect ? 1 : 0;
        row.timeMs  += Number.isFinite(Number(a.timeMs)) ? Number(a.timeMs) : 0;
        row.answeredCount += 1;
      });

      const arr = [...agg.entries()].map(([name,v])=>({
        name,
        correct:v.correct,
        timeSec:(v.timeMs/1000),
        done:(v.answeredCount>=10)
      }));

      arr.sort((x,y)=>(y.correct-x.correct) || (x.timeSec-y.timeSec));

      boardT.innerHTML="";
      arr.forEach((r,idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${idx+1}</td><td>${r.name}</td><td class="ok">${r.correct}</td><td>${r.timeSec.toFixed(1)}</td><td>${r.done ? "âœ…" : "â€”"}</td>`;
        boardT.appendChild(tr);
      });
    });
  });

</script>
</body>
</html>
