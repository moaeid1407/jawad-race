<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ - Ø£Ø¯Ù…Ù†</title>
  <style>
    body{font-family:system-ui,Segoe UI,Tahoma,Arial;margin:20px;line-height:1.7}
    .card{max-width:560px;margin:auto;border:1px solid #ddd;border-radius:14px;padding:16px}
    button{font-size:16px;padding:12px;border-radius:10px;border:1px solid #ccc;cursor:pointer;width:100%}
    .row{display:flex;gap:10px}
    .muted{color:#666}
    .big{font-size:20px;font-weight:700}
    .ok{color:green}
    .warn{color:#b45309}
    .danger{color:#b91c1c}
  </style>
</head>
<body>
  <div class="card">
    <div class="big">ğŸ› Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</div>
    <div class="muted">Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­: ØªØµÙÙŠØ± â†’ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ â†’ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</div>
    <hr/>

    <div class="row">
      <button id="resetBtn">ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
      <button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
    </div>

    <div style="height:10px"></div>
    <button id="nextBtn">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â­ï¸</button>

    <div style="height:10px"></div>
    <button id="finishBtn" class="danger">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>

    <hr/>
    <div id="status" class="warn">Ø¬Ø§Ù‡Ø²â€¦</div>
    <div id="debug" class="muted"></div>
  </div>

<script type="module">
  // âœ… Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù‡Ù†Ø§ (Ù†ÙØ³Ù‡Ø§ ÙÙŠ index.html)
  const firebaseConfig = {
    apiKey: "PUT_YOURS",
    authDomain: "PUT_YOURS",
    projectId: "PUT_YOURS",
    storageBucket: "PUT_YOURS",
    messagingSenderId: "PUT_YOURS",
    appId: "PUT_YOURS",
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    doc,
    collection,
    getDocs,
    getDoc,
    setDoc,
    updateDoc,
    query,
    orderBy,
    limit,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const raceRef = doc(db, "race", "current");
  const questionsCol = collection(db, "questions");

  const statusEl = document.getElementById("status");
  const debugEl  = document.getElementById("debug");

  function setStatus(msg, cls="warn"){ statusEl.className = cls; statusEl.textContent = msg; }

  let questionsCache = null;
  async function loadQuestionsOnce(){
    if (questionsCache) return questionsCache;

    // Ø¥Ø°Ø§ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø­Ù‚Ù„ order ÙÙŠ questions: ØºÙŠÙ‘Ø±Ù‡ Ø¥Ù„Ù‰ createdAt
    const q = query(questionsCol, orderBy("order", "asc"), limit(500));
    const snap = await getDocs(q);

    questionsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (!questionsCache.length) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¯Ø§Ø®Ù„ questions");

    return questionsCache;
  }

  document.getElementById("resetBtn").onclick = async () => {
    await setDoc(raceRef, {
      status: "waiting",
      activeQuestionId: null,
      questionIndex: -1,
      updatedAt: serverTimestamp(),
    }, { merge: true });

    setStatus("âœ… ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¨Ø§Ù‚", "ok");
  };

  document.getElementById("startBtn").onclick = async () => {
    await updateDoc(raceRef, { status: "running", updatedAt: serverTimestamp() });
    setStatus("â–¶ï¸ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ø¨Ø¯Ø£ â€” Ø§Ø¶ØºØ· (Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ)", "ok");
  };

  document.getElementById("nextBtn").onclick = async () => {
    const qs = await loadQuestionsOnce();
    const raceSnap = await getDoc(raceRef);
    const race = raceSnap.exists() ? raceSnap.data() : { questionIndex: -1 };

    const nextIndex = (race.questionIndex ?? -1) + 1;

    if (nextIndex >= qs.length) {
      await updateDoc(raceRef, {
        status: "finished",
        activeQuestionId: null,
        questionIndex: qs.length - 1,
        updatedAt: serverTimestamp(),
      });
      setStatus("ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©", "ok");
      return;
    }

    await updateDoc(raceRef, {
      status: "running",
      activeQuestionId: qs[nextIndex].id,
      questionIndex: nextIndex,
      updatedAt: serverTimestamp(),
    });

    setStatus(`â­ï¸ ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${nextIndex + 1}`, "ok");
  };

  document.getElementById("finishBtn").onclick = async () => {
    await updateDoc(raceRef, {
      status: "finished",
      activeQuestionId: null,
      updatedAt: serverTimestamp(),
    });
    setStatus("â›” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚", "ok");
  };

  onSnapshot(raceRef, (snap) => {
    if (!snap.exists()) {
      debugEl.textContent = "ÙˆØ«ÙŠÙ‚Ø© race/current ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø§Ø¶ØºØ· ØªØµÙÙŠØ±)";
      return;
    }
    const r = snap.data();
    debugEl.textContent = `status=${r.status || "-"} | activeQuestionId=${r.activeQuestionId ?? "null"} | index=${r.questionIndex ?? "-"}`;
  });
</script>
</body>
</html>
