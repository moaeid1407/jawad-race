<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <style>
    body{font-family:system-ui,Tahoma,Arial;background:#f6f7fb;margin:0;padding:18px}
    .wrap{max-width:1200px;margin:auto;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:14px;box-shadow:0 8px 22px rgba(0,0,0,.06)}
    h1{margin:0 0 6px 0;font-size:22px}
    .sub{color:#666;margin-bottom:10px}
    button,input,textarea{padding:12px;border-radius:12px;border:1px solid #d7dbe6;font-size:15px}
    button{cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    textarea{width:100%;min-height:180px;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn-reset{background:#f3f4f6}
    .btn-start{background:#dcfce7}
    .btn-next{background:#dbeafe;grid-column:1/-1}
    .btn-finish{background:#fee2e2;grid-column:1/-1}
    .ok{color:#16a34a;font-weight:800}
    .warn{color:#b45309;font-weight:800}
    .err{color:#dc2626;font-weight:800}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#444;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:right;font-size:14px}
    th{background:#fafafa}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;font-size:12px;text-decoration:none;color:#111}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <h1>ğŸ› Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h1>
        <div class="sub">Ø§Ù„ØªØ´ØºÙŠÙ„: <b>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ø³Ø¦Ù„Ø©</b> â†’ <b>ØªØµÙÙŠØ±</b> â†’ <b>Ø¨Ø¯Ø¡</b> â†’ <b>Ø§Ù„ØªØ§Ù„ÙŠ</b>. (Ø§Ù„Ù…Ø³Ø§Ø±: <span class="mono">race/current</span>)</div>
      </div>
      <a class="pill" href="./?v=999" target="_blank">ÙØªØ­ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</a>
    </div>

    <div class="grid" style="margin-top:10px">
      <button class="btn-reset" id="resetBtn" type="button">ğŸ”„ ØªØµÙÙŠØ±</button>
      <button class="btn-start" id="startBtn" type="button">â–¶ï¸ Ø¨Ø¯Ø¡</button>
      <button class="btn-next"  id="nextBtn"  type="button">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
      <button class="btn-finish" id="finishBtn" type="button">â›” Ø¥Ù†Ù‡Ø§Ø¡</button>
    </div>

    <div style="margin-top:10px" id="msg" class="warn">Ø¬Ø§Ù‡Ø²â€¦</div>
    <div id="dbg" class="mono" style="margin-top:6px"></div>
    <div id="err" class="mono err" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <h1>ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ù‚Ø§Ù„Ø¨ JSON)</h1>
    <div class="sub">Ø§Ù„ØµÙ‚ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ Ø«Ù… Ø§Ø¶ØºØ· <b>Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</b>. Ø³ÙŠÙÙ†Ø´Ø¦: questions + ÙŠØ¶Ø¨Ø· order + correctIndex + ÙˆÙŠØ­Ø¯Ø« race/current ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    <textarea id="qJson"></textarea>
    <div class="grid" style="margin-top:10px">
      <button id="importBtn" type="button">â¬†ï¸ Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
      <button id="wipeBtn" type="button">ğŸ§¹ Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø©/Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª/Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„)</button>
    </div>
    <div class="mono" style="margin-top:10px">ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø­Ø°Ù ÙŠÙ…Ø³Ø­ collections (players/answers/questions) â€” Ø§Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙ‚Ø· Ù„Ùˆ ØªØ¨ØºÙ‰ ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±.</div>
  </div>

  <div class="card">
    <h1>ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (Ø¢Ø®Ø± 50)</h1>
    <table>
      <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
      <tbody id="playersT"></tbody>
    </table>
  </div>

  <div class="card">
    <h1>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ (ØµØ­ÙŠØ­ + ÙˆÙ‚Øª)</h1>
    <div class="sub">ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ <b>correctIndex</b> ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© + Ø­ÙØ¸ answers Ù…Ø¹ timeMs.</div>
    <table>
      <thead>
        <tr>
          <th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµØ­ÙŠØ­</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆÙ‚Øª (Ø«)</th><th>Ø¢Ø®Ø± Ø¥Ø¬Ø§Ø¨Ø©</th>
        </tr>
      </thead>
      <tbody id="boardT"></tbody>
    </table>
  </div>

</div>

<script type="module">
  // âœ… Ø«Ø§Ø¨Øª (Ù„Ø§ ØªØ¹Ø¯Ù‘Ù„)
  const firebaseConfig = {
    apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
    authDomain: "jawad-race.firebaseapp.com",
    projectId: "jawad-race",
    storageBucket: "jawad-race.firebasestorage.app",
    messagingSenderId: "677185572718",
    appId: "1:677185572718:web:91c4674236efce1d6efb7f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, collection, setDoc, updateDoc, getDoc, getDocs, addDoc,
    query, orderBy, limit, serverTimestamp, onSnapshot, where,
    writeBatch, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const raceRef      = doc(db, "race", "current");
  const questionsCol = collection(db, "questions");
  const playersCol   = collection(db, "players");
  const answersCol   = collection(db, "answers");

  const msgEl = document.getElementById("msg");
  const dbgEl = document.getElementById("dbg");
  const errEl = document.getElementById("err");

  const playersT = document.getElementById("playersT");
  const boardT   = document.getElementById("boardT");

  const qJsonEl  = document.getElementById("qJson");

  const say = (t, cls="warn") => { msgEl.className = cls; msgEl.textContent = t; };
  const setErr = (t="") => { errEl.textContent = t; };

  // Ø¶Ø¹ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ (ÙŠØ³Ø§Ø¹Ø¯Ùƒ)
  qJsonEl.value = `[
  {
    "text": "Ø£ÙŠÙ† ÙˆÙÙ„Ø¯ Ø§Ù„Ø¥Ù…Ø§Ù… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)ØŸ",
    "options": ["Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©", "Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©", "Ø§Ù„ÙƒÙˆÙØ©", "Ø¨ØºØ¯Ø§Ø¯"],
    "correctIndex": 0,
    "durationSec": 20
  },
  {
    "text": "Ù…Ù† Ù‡Ùˆ ÙˆØ§Ù„Ø¯ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)ØŸ",
    "options": ["Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ø¸Ù… (Ø¹)", "Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø±Ø¶Ø§ (Ø¹)", "Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù‡Ø§Ø¯ÙŠ (Ø¹)", "Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„ØµØ§Ø¯Ù‚ (Ø¹)"],
    "correctIndex": 1,
    "durationSec": 20
  }
]`;

  // ---- Controls ----
  async function resetRace(){
    const qSnap = await getDocs(query(questionsCol, orderBy("order","asc"), limit(1000)));
    const ids = qSnap.docs.map(d=>d.id);
    await setDoc(raceRef, {
      status: "waiting",
      activeQuestionId: null,
      questionIndex: -1,
      questionsOrder: ids,
      questionStartedAt: null,
      updatedAt: serverTimestamp(),
    }, { merge:true });
  }

  async function startRace(){
    await updateDoc(raceRef, { status:"running", updatedAt: serverTimestamp() });
  }

  async function nextQuestion(){
    const rs = await getDoc(raceRef);
    const r  = rs.exists()? rs.data() : {};
    const order = Array.isArray(r.questionsOrder) && r.questionsOrder.length ? r.questionsOrder : [];

    if(!order.length){
      // Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ ØªØ±ØªÙŠØ¨ØŒ Ù†Ø¨Ù†ÙŠÙ‡ Ù…Ù† questions
      const qSnap = await getDocs(query(questionsCol, orderBy("order","asc"), limit(1000)));
      const ids = qSnap.docs.map(d=>d.id);
      if(!ids.length) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ù‹Ø§.");
      await updateDoc(raceRef, { questionsOrder: ids, updatedAt: serverTimestamp() });
      return nextQuestion();
    }

    const nextIndex = (r.questionIndex ?? -1) + 1;

    if(nextIndex >= order.length){
      await updateDoc(raceRef, { status:"finished", activeQuestionId:null, updatedAt: serverTimestamp() });
      say("ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©","ok");
      return;
    }

    const nextId = order[nextIndex];
    // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯
    const qCheck = await getDoc(doc(db,"questions",nextId));
    if(!qCheck.exists()){
      // ØªØ®Ø·ÙŠ
      await updateDoc(raceRef, { questionIndex: nextIndex, updatedAt: serverTimestamp() });
      say("âš ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","warn");
      return nextQuestion();
    }

    await updateDoc(raceRef, {
      status:"running",
      activeQuestionId: nextId,
      questionIndex: nextIndex,
      questionStartedAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    });
    say(`â­ï¸ ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${nextIndex+1}`,"ok");
  }

  async function finishRace(){
    await updateDoc(raceRef, { status:"finished", activeQuestionId:null, updatedAt: serverTimestamp() });
    say("â›” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚","ok");
  }

  document.getElementById("resetBtn").onclick = async()=>{ setErr(""); try{ await resetRace(); say("âœ… ØªÙ… Ø§Ù„ØªØµÙÙŠØ±","ok"); }catch(e){ say("âŒ ÙØ´Ù„ Ø§Ù„ØªØµÙÙŠØ±","err"); setErr(e?.message||String(e)); } };
  document.getElementById("startBtn").onclick = async()=>{ setErr(""); try{ await startRace(); say("â–¶ï¸ Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø¨Ø§Ù‚","ok"); }catch(e){ say("âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø¯Ø¡","err"); setErr(e?.message||String(e)); } };
  document.getElementById("nextBtn").onclick  = async()=>{ setErr(""); try{ await nextQuestion(); }catch(e){ say("âŒ ÙØ´Ù„ Ø§Ù„ØªØ§Ù„ÙŠ","err"); setErr(e?.message||String(e)); } };
  document.getElementById("finishBtn").onclick= async()=>{ setErr(""); try{ await finishRace(); }catch(e){ say("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡","err"); setErr(e?.message||String(e)); } };

  // ---- Import questions ----
  document.getElementById("importBtn").onclick = async()=>{
    setErr("");
    try{
      const arr = JSON.parse(qJsonEl.value || "[]");
      if(!Array.isArray(arr) || !arr.length) throw new Error("JSON Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Array ÙˆÙÙŠÙ‡ Ø¹Ù†Ø§ØµØ±.");

      // Ù†ÙƒØªØ¨ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¢ÙŠ Ø¯ÙŠ Ø«Ø§Ø¨Øª q1 q2...
      const batch = writeBatch(db);
      const ids = [];

      arr.forEach((q, i)=>{
        const id = `q${i+1}`;
        ids.push(id);

        const text = q.text || q.question;
        const options = Array.isArray(q.options) ? q.options : [];
        if(!text) throw new Error(`Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${i+1} Ù†Ø§Ù‚Øµ text`);
        if(options.length < 2) throw new Error(`Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${i+1} Ù†Ø§Ù‚Øµ options`);

        const correctIndex = Number.isFinite(Number(q.correctIndex)) ? Number(q.correctIndex) : 0;
        const durationSec  = Number.isFinite(Number(q.durationSec))  ? Number(q.durationSec)  : 20;

        batch.set(doc(db,"questions",id), {
          text,
          options: options.map(String),
          correctIndex,
          durationSec,
          order: i+1,
          updatedAt: serverTimestamp(),
          createdAt: serverTimestamp(),
        }, { merge:true });
      });

      await batch.commit();

      // Ø­Ø¯Ø« Ø§Ù„Ø³Ø¨Ø§Ù‚
      await setDoc(raceRef, {
        status: "waiting",
        activeQuestionId: null,
        questionIndex: -1,
        questionsOrder: ids,
        questionStartedAt: null,
        updatedAt: serverTimestamp(),
      }, { merge:true });

      say(`âœ… ØªÙ… Ø±ÙØ¹ ${arr.length} Ø³Ø¤Ø§Ù„ ÙˆØ¶Ø¨Ø· Ø§Ù„Ø³Ø¨Ø§Ù‚`,"ok");
    }catch(e){
      say("âŒ ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©","err");
      setErr(e?.message||String(e));
    }
  };

  // ---- Wipe (danger) ----
  async function deleteAllIn(colRef, batchSize=200){
    const snap = await getDocs(query(colRef, limit(batchSize)));
    if(snap.empty) return;
    const batch = writeBatch(db);
    snap.docs.forEach(d=> batch.delete(d.ref));
    await batch.commit();
    if(snap.size === batchSize) await deleteAllIn(colRef, batchSize);
  }

  document.getElementById("wipeBtn").onclick = async()=>{
    setErr("");
    try{
      if(!confirm("ØªØ£ÙƒÙŠØ¯: Ø³ÙŠØªÙ… Ø­Ø°Ù questions + answers + players Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù…ÙˆØ§ÙÙ‚ØŸ")) return;
      await deleteAllIn(playersCol);
      await deleteAllIn(answersCol);
      await deleteAllIn(questionsCol);
      await setDoc(raceRef, { status:"waiting", activeQuestionId:null, questionIndex:-1, questionsOrder:[], updatedAt: serverTimestamp() }, {merge:true});
      say("âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ù…Ù„","ok");
    }catch(e){
      say("âŒ ÙØ´Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ","err");
      setErr(e?.message||String(e));
    }
  };

  // ---- Debug ----
  onSnapshot(raceRef, (snap)=>{
    if(!snap.exists()){
      dbgEl.textContent = "race/current ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â€” Ø§Ø³ØªØ®Ø¯Ù… (Ø§Ø³ØªÙŠØ±Ø§Ø¯) Ø«Ù… (ØªØµÙÙŠØ±)";
      return;
    }
    const r = snap.data();
    dbgEl.textContent = `status=${r.status||"-"} | activeQuestionId=${r.activeQuestionId ?? "null"} | index=${r.questionIndex ?? "-"}`;
  });

  // ---- Players list ----
  onSnapshot(query(playersCol, orderBy("createdAt","desc"), limit(50)), (snap)=>{
    playersT.innerHTML = "";
    let i=1;
    snap.forEach(d=>{
      const p = d.data();
      const tr = document.createElement("tr");
      const t = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleTimeString("ar-SA") : "";
      tr.innerHTML = `<td>${i++}</td><td>${(p.name||"")}</td><td class="mono">${t}</td>`;
      playersT.appendChild(tr);
    });
  });

  // ---- Leaderboard ----
  async function loadCorrectMap(){
    const s = await getDocs(query(questionsCol, orderBy("order","asc"), limit(1000)));
    const map = new Map();
    s.forEach(d=>{
      const q = d.data();
      map.set(d.id, Number.isFinite(Number(q.correctIndex)) ? Number(q.correctIndex) : null);
    });
    return map;
  }

  onSnapshot(query(answersCol, orderBy("createdAt","asc"), limit(5000)), async (snap)=>{
    const correctMap = await loadCorrectMap();
    const agg = new Map(); // name -> {correct,time,last}
    snap.forEach(d=>{
      const a = d.data();
      const name = a.playerName || "â€”";
      const qid  = a.questionId;
      const chosen = Number(a.optionIndex);
      const corr   = correctMap.get(qid);

      if(!agg.has(name)) agg.set(name, {correct:0, time:0, last:""});
      const row = agg.get(name);

      const tms = Number(a.timeMs);
      row.time += Number.isFinite(tms) ? Math.max(0,tms)/1000 : 0;

      if(Number.isFinite(corr) && Number.isFinite(chosen) && chosen===corr) row.correct += 1;
      row.last = a.createdAt?.toDate ? a.createdAt.toDate().toLocaleTimeString("ar-SA") : row.last;
    });

    const arr = [...agg.entries()].map(([name,v])=>({name,...v}));
    arr.sort((x,y)=>(y.correct-x.correct) || (x.time-y.time));

    boardT.innerHTML="";
    arr.forEach((r,idx)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${idx+1}</td><td>${r.name}</td><td class="ok">${r.correct}</td><td>${r.time.toFixed(1)}</td><td class="mono">${r.last}</td>`;
      boardT.appendChild(tr);
    });
  });

</script>
</body>
</html>
