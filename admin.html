<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† â€“ Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯</title>

  <style>
    body {
      font-family: Tahoma, Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .box {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,.1);
    }
    h1 { margin-top: 0 }
    button {
      width: 100%;
      padding: 14px;
      margin: 6px 0;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .reset { background:#eee }
    .start { background:#d1fae5 }
    .next  { background:#bfdbfe }
    .finish{ background:#fee2e2 }
    .status {
      margin-top: 15px;
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 14px;
    }
    .debug {
      margin-top: 8px;
      color: #666;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="box">
  <h1>ğŸ› Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h1>

  <button class="reset"  id="resetBtn">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
  <button class="start"  id="startBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
  <button class="next"   id="nextBtn">â­ï¸ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
  <button class="finish" id="finishBtn">â›” Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>

  <div class="status" id="status">Ø¬Ø§Ù‡Ø²â€¦</div>
  <div class="debug"  id="debug"></div>
</div>

<script type="module">
  /***********************
   * 1ï¸âƒ£ Ø¨ÙŠØ§Ù†Ø§Øª Firebase
   * ØºÙŠÙ‘Ø± PUT_YOURS ÙÙ‚Ø·
   ***********************/
  const firebaseConfig = {
    apiKey: "PUT_YOURS",
    authDomain: "PUT_YOURS",
    projectId: "PUT_YOURS",
    storageBucket: "PUT_YOURS",
    messagingSenderId: "PUT_YOURS",
    appId: "PUT_YOURS"
  };

  /***********************
   * 2ï¸âƒ£ Firebase Imports
   ***********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    doc,
    collection,
    getDocs,
    getDoc,
    setDoc,
    updateDoc,
    query,
    orderBy,
    limit,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ğŸ”‘ Ù…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø§Ù„ÙˆØ­ÙŠØ¯
  const raceRef      = doc(db, "race", "current");
  const questionsCol = collection(db, "questions");

  const statusEl = document.getElementById("status");
  const debugEl  = document.getElementById("debug");

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  /***********************
   * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø±Ø© ÙˆØ­Ø¯Ø©
   ***********************/
  let questionsCache = null;
  async function loadQuestions() {
    if (questionsCache) return questionsCache;

    const q = query(questionsCol, orderBy("order", "asc"), limit(500));
    const snap = await getDocs(q);

    questionsCache = snap.docs.map(d => ({
      id: d.id,
      ...d.data()
    }));

    if (!questionsCache.length)
      throw "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Collection questions";

    return questionsCache;
  }

  /***********************
   * Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†
   ***********************/
  document.getElementById("resetBtn").onclick = async () => {
    await setDoc(raceRef, {
      status: "waiting",
      activeQuestionId: null,
      questionIndex: -1,
      updatedAt: serverTimestamp()
    }, { merge:true });

    setStatus("âœ… ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¨Ø§Ù‚");
  };

  document.getElementById("startBtn").onclick = async () => {
    await updateDoc(raceRef, {
      status: "running",
      updatedAt: serverTimestamp()
    });

    setStatus("â–¶ï¸ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ø¨Ø¯Ø£ â€“ Ø§Ø¶ØºØ· (Ø§Ù„ØªØ§Ù„ÙŠ)");
  };

  document.getElementById("nextBtn").onclick = async () => {
    const qs = await loadQuestions();
    const snap = await getDoc(raceRef);
    const race = snap.exists() ? snap.data() : { questionIndex:-1 };

    const nextIndex = (race.questionIndex ?? -1) + 1;

    if (nextIndex >= qs.length) {
      await updateDoc(raceRef, {
        status: "finished",
        activeQuestionId: null,
        updatedAt: serverTimestamp()
      });
      setStatus("ğŸ Ø§Ù†ØªÙ‡Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©");
      return;
    }

    await updateDoc(raceRef, {
      status: "running",
      activeQuestionId: qs[nextIndex].id,
      questionIndex: nextIndex,
      updatedAt: serverTimestamp()
    });

    setStatus(`â­ï¸ ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${nextIndex + 1}`);
  };

  document.getElementById("finishBtn").onclick = async () => {
    await updateDoc(raceRef, {
      status: "finished",
      activeQuestionId: null,
      updatedAt: serverTimestamp()
    });

    setStatus("â›” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚");
  };

  /***********************
   * Debug Ø­ÙŠ
   ***********************/
  onSnapshot(raceRef, (snap) => {
    if (!snap.exists()) {
      debugEl.textContent = "âš ï¸ ÙˆØ«ÙŠÙ‚Ø© race/current ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
      return;
    }
    const r = snap.data();
    debugEl.textContent =
      `status=${r.status} | activeQuestionId=${r.activeQuestionId ?? "null"} | index=${r.questionIndex ?? "-"}`;
  });
</script>

</body>
</html>
