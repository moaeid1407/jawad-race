<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <style>
    body{font-family:system-ui,Segoe UI,Tahoma,Arial;background:#f6f7fb;margin:0;padding:18px}
    .wrap{max-width:1100px;margin:auto;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    h1{margin:0 0 6px 0;font-size:22px}
    .sub{color:#666;margin-bottom:10px}
    button,input{padding:12px;border-radius:12px;border:1px solid #d7dbe6;font-size:15px}
    button{cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn-reset{background:#f3f4f6}
    .btn-start{background:#dcfce7}
    .btn-next{background:#dbeafe;grid-column:1/-1}
    .btn-finish{background:#fee2e2;grid-column:1/-1}
    .ok{color:#16a34a;font-weight:800}
    .warn{color:#b45309;font-weight:800}
    .err{color:#dc2626;font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:#444;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:right;font-size:14px}
    th{background:#fafafa}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <h1>ğŸ› Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h1>
        <div class="sub">Ø§Ù„ØªØ´ØºÙŠÙ„: ØªØµÙÙŠØ± â†’ Ø¨Ø¯Ø¡ â†’ (Auto Ø£Ùˆ Ø§Ù„ØªØ§Ù„ÙŠ). Ø§Ù„Ù…Ø³Ø§Ø±: <span class="mono">race/current</span></div>
      </div>
      <a class="pill" href="./?v=999" target="_blank">ÙØªØ­ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</a>
    </div>

    <div class="grid" style="margin-top:10px">
      <button class="btn-reset" id="resetBtn" type="button">ğŸ”„ ØªØµÙÙŠØ±</button>
      <button class="btn-start" id="startBtn" type="button">â–¶ï¸ Ø¨Ø¯Ø¡</button>
      <button class="btn-next"  id="nextBtn"  type="button">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
      <button class="btn-finish" id="finishBtn" type="button">â›” Ø¥Ù†Ù‡Ø§Ø¡</button>
    </div>

    <div style="margin-top:10px" class="grid">
      <input id="autoSec" type="number" min="5" value="20" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ" />
      <button id="autoToggle" type="button">ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ: OFF</button>
    </div>

    <div style="margin-top:10px" id="msg" class="warn">Ø¬Ø§Ù‡Ø²â€¦</div>
    <div id="dbg" class="mono" style="margin-top:6px"></div>
    <div id="err" class="mono err" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <h1>ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (Ø¢Ø®Ø± 50)</h1>
    <div class="sub">Ø¥Ø°Ø§ Ù…Ø§ Ø¸Ù‡Ø±ÙˆØ§ Ù‡Ù†Ø§ ÙØ§Ù„Ù…Ø´ÙƒÙ„Ø© Ù„ÙŠØ³Øª â€œÙƒÙˆØ¯â€ Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ players.</div>
    <table>
      <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
      <tbody id="playersT"></tbody>
    </table>
  </div>

  <div class="card" style="grid-column:1/-1">
    <h1>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ (ØµØ­ÙŠØ­ + ÙˆÙ‚Øª)</h1>
    <div class="sub">ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ <b>correctIndex</b> Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø³Ø¤Ø§Ù„.</div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</th>
          <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆÙ‚Øª (Ø«)</th>
          <th>Ø¢Ø®Ø± Ø¥Ø¬Ø§Ø¨Ø©</th>
        </tr>
      </thead>
      <tbody id="boardT"></tbody>
    </table>
  </div>
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
    authDomain: "jawad-race.firebaseapp.com",
    projectId: "jawad-race",
    storageBucket: "jawad-race.firebasestorage.app",
    messagingSenderId: "677185572718",
    appId: "1:677185572718:web:91c4674236efce1d6efb7f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, collection, setDoc, updateDoc, getDoc, getDocs,
    query, orderBy, limit, serverTimestamp, onSnapshot, where
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const raceRef      = doc(db, "race", "current");
  const questionsCol = collection(db, "questions");
  const playersCol   = collection(db, "players");
  const answersCol   = collection(db, "answers");

  const msgEl = document.getElementById("msg");
  const dbgEl = document.getElementById("dbg");
  const errEl = document.getElementById("err");

  const playersT = document.getElementById("playersT");
  const boardT   = document.getElementById("boardT");

  const autoSecInput = document.getElementById("autoSec");
  const autoToggleBtn = document.getElementById("autoToggle");

  const say = (t, cls="warn") => { msgEl.className = cls; msgEl.textContent = t; };
  const setErr = (t="") => { errEl.textContent = t; };

  // -------- Questions loading (IDs Ø­Ù‚ÙŠÙ‚ÙŠØ©) --------
  let questions = [];
  async function loadQuestions(){
    // ÙŠØ­Ø§ÙˆÙ„ order Ø«Ù… createdAt Ø«Ù… Ø¨Ø¯ÙˆÙ† ØªØ±ØªÙŠØ¨
    try{
      const s1 = await getDocs(query(questionsCol, orderBy("order","asc"), limit(500)));
      questions = s1.docs.map(d=>({id:d.id, ...d.data()}));
      if(questions.length) return questions;
    }catch(_){}
    try{
      const s2 = await getDocs(query(questionsCol, orderBy("createdAt","asc"), limit(500)));
      questions = s2.docs.map(d=>({id:d.id, ...d.data()}));
      if(questions.length) return questions;
    }catch(_){}
    const s3 = await getDocs(query(questionsCol, limit(500)));
    questions = s3.docs.map(d=>({id:d.id, ...d.data()}));
    if(!questions.length) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¯Ø§Ø®Ù„ questions");
    return questions;
  }

  function getDurationForIndex(i){
    const q = questions[i];
    const d = Number(q?.durationSec);
    const fallback = Number(autoSecInput.value || 20);
    return Number.isFinite(d) && d>0 ? d : (Number.isFinite(fallback)&&fallback>0?fallback:20);
  }

  // -------- Race controls --------
  async function resetRace(){
    await loadQuestions();
    await setDoc(raceRef, {
      status: "waiting",
      activeQuestionId: null,
      questionIndex: -1,
      updatedAt: serverTimestamp(),
      // Ù†Ø®Ø²Ù† IDs Ù…Ø±ØªØ¨Ø© Ù„ØªÙØ§Ø¯ÙŠ "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
      questionsOrder: questions.map(q=>q.id),
    }, { merge:true });
  }

  async function startRace(){
    await updateDoc(raceRef, { status:"running", updatedAt: serverTimestamp() });
  }

  async function nextQuestion(){
    await loadQuestions();
    const rs = await getDoc(raceRef);
    const r  = rs.exists()? rs.data() : { questionIndex: -1 };
    const order = Array.isArray(r.questionsOrder) && r.questionsOrder.length ? r.questionsOrder : questions.map(q=>q.id);

    const nextIndex = (r.questionIndex ?? -1) + 1;

    if(nextIndex >= order.length){
      await updateDoc(raceRef, { status:"finished", activeQuestionId:null, updatedAt: serverTimestamp() });
      say("ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©","ok");
      return;
    }

    const nextId = order[nextIndex];
    // ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹
    const qSnap = await getDoc(doc(db,"questions", nextId));
    if(!qSnap.exists()){
      // ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¯Ù„ Ù…Ø§ ÙŠØ¹Ù„Ù‚ Ø§Ù„Ø³Ø¨Ø§Ù‚
      await updateDoc(raceRef, { questionIndex: nextIndex, updatedAt: serverTimestamp() });
      say("âš ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø³Ø¤Ø§Ù„ ID ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","warn");
      return nextQuestion();
    }

    await updateDoc(raceRef, {
      status:"running",
      activeQuestionId: nextId,
      questionIndex: nextIndex,
      questionStartedAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      questionsOrder: order,
    });

    say(`â­ï¸ ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${nextIndex+1}`,"ok");
  }

  async function finishRace(){
    await updateDoc(raceRef, { status:"finished", activeQuestionId:null, updatedAt: serverTimestamp() });
    say("â›” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚","ok");
  }

  document.getElementById("resetBtn").onclick = async()=>{ setErr(""); try{ await resetRace(); say("âœ… ØªÙ… Ø§Ù„ØªØµÙÙŠØ±","ok"); }catch(e){ say("âŒ ÙØ´Ù„ Ø§Ù„ØªØµÙÙŠØ±","err"); setErr(e?.message||String(e)); } };
  document.getElementById("startBtn").onclick = async()=>{ setErr(""); try{ await startRace(); say("â–¶ï¸ Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø¨Ø§Ù‚","ok"); }catch(e){ say("âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø¯Ø¡","err"); setErr(e?.message||String(e)); } };
  document.getElementById("nextBtn").onclick  = async()=>{ setErr(""); try{ await nextQuestion(); }catch(e){ say("âŒ ÙØ´Ù„ Ø§Ù„ØªØ§Ù„ÙŠ","err"); setErr(e?.message||String(e)); } };
  document.getElementById("finishBtn").onclick= async()=>{ setErr(""); try{ await finishRace(); }catch(e){ say("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡","err"); setErr(e?.message||String(e)); } };

  // -------- Auto mode --------
  let autoOn = false;
  let autoTimer = null;

  function setAutoUI(){
    autoToggleBtn.textContent = `ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${autoOn ? "ON" : "OFF"}`;
    autoToggleBtn.style.background = autoOn ? "#dcfce7" : "#f3f4f6";
  }
  setAutoUI();

  autoToggleBtn.onclick = async()=>{
    autoOn = !autoOn;
    setAutoUI();
    if(autoTimer){ clearTimeout(autoTimer); autoTimer=null; }
    if(autoOn){
      say("âœ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ON â€” Ø³ÙŠØ°Ù‡Ø¨ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø©","ok");
      scheduleAuto();
    }else{
      say("â¸ï¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ OFF","warn");
    }
  };

  async function scheduleAuto(){
    if(!autoOn) return;
    const rs = await getDoc(raceRef);
    const r  = rs.exists()? rs.data(): null;
    if(!r || r.status!=="running"){ autoTimer=setTimeout(scheduleAuto, 1500); return; }

    // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ Ø³Ø¤Ø§Ù„ Ù†Ø´Ø·ØŒ Ø£Ø·Ù„Ù‚ Ø£ÙˆÙ„ Ø³Ø¤Ø§Ù„
    if(!r.activeQuestionId){
      await nextQuestion();
      autoTimer=setTimeout(scheduleAuto, 500);
      return;
    }

    // Ø§Ù„Ù…Ø¯Ø© = Ù…Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    await loadQuestions();
    const idx = r.questionIndex ?? 0;
    const sec = getDurationForIndex(idx);
    autoTimer = setTimeout(async ()=>{
      try{ await nextQuestion(); }catch(_){}
      scheduleAuto();
    }, sec*1000);
  }

  // -------- Live debug --------
  onSnapshot(raceRef, (snap)=>{
    if(!snap.exists()){
      dbgEl.textContent = "race/current ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â€” Ø§Ø¶ØºØ· (ØªØµÙÙŠØ±)";
      return;
    }
    const r = snap.data();
    dbgEl.textContent = `status=${r.status||"-"} | activeQuestionId=${r.activeQuestionId ?? "null"} | index=${r.questionIndex ?? "-"}`;
  }, (e)=>{ dbgEl.textContent = "Listener error: " + (e?.message||String(e)); });

  // -------- Players list --------
  onSnapshot(query(playersCol, orderBy("createdAt","desc"), limit(50)), (snap)=>{
    playersT.innerHTML = "";
    let i=1;
    snap.forEach(d=>{
      const p = d.data();
      const tr = document.createElement("tr");
      const t = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleTimeString("ar-SA") : "";
      tr.innerHTML = `<td>${i++}</td><td>${(p.name||"")}</td><td class="mono">${t}</td>`;
      playersT.appendChild(tr);
    });
  });

  // -------- Leaderboard (correct + time) --------
  // ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰: answers(questionId, playerName, optionIndex, createdAt, timeMs optional)
  // Ùˆ questions(correctIndex)
  async function buildQuestionCorrectMap(){
    await loadQuestions();
    const map = new Map();
    questions.forEach(q=>{
      if(Number.isFinite(Number(q.correctIndex))) map.set(q.id, Number(q.correctIndex));
    });
    return map;
  }

  let correctMap = new Map();
  correctMap = await buildQuestionCorrectMap();

  onSnapshot(query(answersCol, orderBy("createdAt","asc"), limit(2000)), async (snap)=>{
    // ØªØ­Ø¯ÙŠØ« correctMap Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
    correctMap = await buildQuestionCorrectMap();

    const agg = new Map(); // name -> {correct, time, last}
    snap.forEach(d=>{
      const a = d.data();
      const name = a.playerName || "â€”";
      const qid = a.questionId;
      const chosen = Number(a.optionIndex);
      const corr = correctMap.get(qid);

      if(!agg.has(name)) agg.set(name, {correct:0, time:0, last:""});
      const row = agg.get(name);

      // ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ timeMs Ø§Ø³ØªØ®Ø¯Ù…Ù‡ØŒ ÙˆØ¥Ù„Ø§ 0 (Ù…Ø§ Ø±Ø§Ø­ ÙŠÙƒØ³Ø± Ø§Ù„ØªØ±ØªÙŠØ¨)
      const t = Number(a.timeMs);
      row.time += Number.isFinite(t) ? Math.max(0, t)/1000 : 0;

      if(Number.isFinite(corr) && Number.isFinite(chosen) && chosen===corr) row.correct += 1;

      const lt = a.createdAt?.toDate ? a.createdAt.toDate().toLocaleTimeString("ar-SA") : "";
      row.last = lt;
    });

    // ØªØ±ØªÙŠØ¨: correct desc Ø«Ù… time asc
    const arr = [...agg.entries()].map(([name,v])=>({name,...v}));
    arr.sort((x,y)=> (y.correct-x.correct) || (x.time-y.time));

    boardT.innerHTML="";
    arr.forEach((r,idx)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${idx+1}</td><td>${r.name}</td><td class="ok">${r.correct}</td><td>${r.time.toFixed(1)}</td><td class="mono">${r.last}</td>`;
      boardT.appendChild(tr);
    });
  });

</script>
</body>
</html>
