<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</title>
  <style>
    body{font-family:system-ui,Tahoma;background:#f6f7fb;margin:0;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;margin:auto;max-width:560px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    h1{margin:0 0 8px 0}
    input,button{width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;font-size:16px;margin-top:8px}
    button{cursor:pointer}
    .opt{background:#f1f5f9;margin-top:10px;text-align:right}
    .opt:hover{background:#e2e8f0}
    .ok{color:#16a34a;font-weight:800}
    .err{color:#dc2626;font-weight:800}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;color:#555;white-space:pre-wrap}
    .muted{color:#666}
  </style>
</head>
<body>
<div class="card">
  <h1>ğŸ Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</h1>
  <div class="muted">Ø³Ø¬Ù‘Ù„ Ø§Ø³Ù…Ùƒ. Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø¯Ù…Ù† ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (10 Ø£Ø³Ø¦Ù„Ø© / Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†).</div>

  <input id="nameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
  <button id="joinBtn" type="button">ØªØ³Ø¬ÙŠÙ„</button>
  <button id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø§Ø³Ù…</button>

  <div id="raceStatus" class="mono" style="margin-top:10px">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø¯Ù…Ù†â€¦</div>
  <div id="msg" style="margin-top:8px"></div>

  <hr style="margin:14px 0">

  <h3 id="questionText">â€”</h3>
  <div id="options"></div>
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
    authDomain: "jawad-race.firebaseapp.com",
    projectId: "jawad-race",
    storageBucket: "jawad-race.firebasestorage.app",
    messagingSenderId: "677185572718",
    appId: "1:677185572718:web:91c4674236efce1d6efb7f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, collection, setDoc, addDoc, getDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const raceRef      = doc(db, "race", "current");
  const playersCol   = collection(db, "players");
  const answersCol   = collection(db, "answers");

  const $ = (id)=>document.getElementById(id);
  const msg = (t, cls="") => { $("msg").innerHTML = `<div class="${cls}">${t}</div>`; };

  const LS = "jr_player_name";
  const getName = ()=>localStorage.getItem(LS)||"";
  const setNameLS = (v)=>localStorage.setItem(LS,v);
  const clearNameLS = ()=>localStorage.removeItem(LS);

  let raceState = { status:"waiting", raceId:null, durationSec:120, questionsOrder:[] };
  let startedAtLocalMs = null;

  let questionIndex = 0;
  let currentQuestion = null;
  let questionShownAtMs = null;
  let answeredSet = new Set(); // questionId answered

  function renderName(){
    $("nameInput").value = getName() || "";
  }
  renderName();

  function nameKey(name){
    return encodeURIComponent(name.trim().toLowerCase());
  }

  $("joinBtn").onclick = async()=>{
    const name = $("nameInput").value.trim();
    if(!name){ msg("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ","err"); return; }

    // doc Ø«Ø§Ø¨Øª Ù„ÙƒÙ„ Ø§Ø³Ù… ÙŠÙ…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø¶Ø®Ù…
    const pRef = doc(db, "players", nameKey(name));
    await setDoc(pRef, { name, updatedAt: serverTimestamp() }, { merge:true });

    setNameLS(name);
    msg("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„","ok");
  };

  $("clearBtn").onclick = ()=>{
    clearNameLS();
    $("nameInput").value="";
    msg("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø§Ø³Ù…");
  };

  function showQuestion(q){
    currentQuestion = q;
    $("questionText").textContent = q.text || "â€”";
    $("options").innerHTML = "";
    questionShownAtMs = Date.now();

    if(!Array.isArray(q.options) || q.options.length !== 4){
      msg("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ options. Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.","err");
      return;
    }

    q.options.forEach((opt,i)=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="opt";
      b.textContent = `(${i+1}) ${opt}`;
      b.onclick = ()=>submitAnswer(i);
      $("options").appendChild(b);
    });
  }

  async function loadQuestionById(qid){
    const qsnap = await getDoc(doc(db,"questions",qid));
    if(!qsnap.exists()){
      msg("âŒ Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©)","err");
      return null;
    }
    return qsnap.data();
  }

  async function gotoIndex(i){
    const order = raceState.questionsOrder || [];
    if(i >= order.length){
      $("questionText").textContent = "âœ… Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©";
      $("options").innerHTML = "";
      msg("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ 10 Ø£Ø³Ø¦Ù„Ø©.","ok");
      return;
    }
    questionIndex = i;
    const qid = order[i];
    const q = await loadQuestionById(qid);
    if(!q) return;
    showQuestion(q);
  }

  async function submitAnswer(optionIndex){
    const name = getName();
    if(!name){ msg("âŒ Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ù‹Ø§","err"); return; }
    if(raceState.status !== "running"){ msg("Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø¯Ù…Ù†â€¦"); return; }

    const qid = raceState.questionsOrder[questionIndex];
    if(!qid || answeredSet.has(qid)) return;

    // Ù…Ù†Ø¹ Ø¶ØºØ· Ù…ØªØ¹Ø¯Ø¯
    [...$("options").querySelectorAll("button")].forEach(b=>b.disabled=true);

    const timeMs = questionShownAtMs ? Math.max(0, Date.now() - questionShownAtMs) : null;
    const correctIndex = Number.isFinite(Number(currentQuestion?.correctIndex)) ? Number(currentQuestion.correctIndex) : -1;
    const isCorrect = (correctIndex === optionIndex);

    await addDoc(answersCol,{
      raceId: raceState.raceId,
      playerName: name,
      questionId: qid,
      optionIndex,
      isCorrect,
      timeMs,
      createdAt: serverTimestamp()
    });

    answeredSet.add(qid);

    // ÙŠÙ†ØªÙ‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
    await gotoIndex(questionIndex + 1);
  }

  // Listener Ù„Ù„Ø³Ø¨Ø§Ù‚
  onSnapshot(raceRef, async (snap)=>{
    if(!snap.exists()) return;
    const r = snap.data();

    raceState = {
      status: r.status || "waiting",
      raceId: r.raceId || null,
      durationSec: Number.isFinite(Number(r.durationSec)) ? Number(r.durationSec) : 120,
      questionsOrder: Array.isArray(r.questionsOrder) ? r.questionsOrder : []
    };

    $("raceStatus").textContent =
      `status=${raceState.status} | raceId=${raceState.raceId||"null"} | questions=${raceState.questionsOrder.length}/10`;

    // Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø³Ø¨Ø§Ù‚ Ø¬Ø¯ÙŠØ¯ (raceId ØªØºÙŠØ±) Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±
    if(raceState.status === "running" && raceState.raceId){
      if(!startedAtLocalMs){
        startedAtLocalMs = Date.now();
        questionIndex = 0;
        answeredSet = new Set();
        msg("ğŸš€ Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!","ok");
        await gotoIndex(0);
      }
    }

    // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø³Ø¨Ø§Ù‚
    if(raceState.status === "finished"){
      $("options").innerHTML = "";
      msg("â›” Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©.","ok");
    }
  });

  // Ù…Ø¤Ù‚Øª Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† Ù…Ø­Ù„ÙŠ (Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯ 120 Ø«Ø§Ù†ÙŠØ©)
  setInterval(()=>{
    if(raceState.status !== "running" || !raceState.raceId) return;
    if(!startedAtLocalMs) return;
    const elapsed = (Date.now() - startedAtLocalMs) / 1000;
    const left = Math.max(0, raceState.durationSec - elapsed);
    $("raceStatus").textContent =
      `status=${raceState.status} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ=${left.toFixed(0)}Ø« | Ø³Ø¤Ø§Ù„ ${questionIndex+1}/10`;
    if(left <= 0){
      $("options").innerHTML = "";
      $("questionText").textContent = "â± Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª";
      msg("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†.","ok");
    }
  }, 500);

</script>
</body>
</html>
