<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</title>

  <style>
    body{font-family:system-ui,Tahoma;background:#f6f7fb;margin:0;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;margin:auto;max-width:520px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    h1{margin-top:0}
    input,button{width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;font-size:16px;margin-top:8px}
    button{cursor:pointer}
    .opt{background:#f1f5f9;margin-top:8px}
    .opt:hover{background:#e2e8f0}
    .ok{color:#16a34a;font-weight:700}
    .err{color:#dc2626;font-weight:700}
    .mono{font-family:monospace;font-size:13px;color:#555}
  </style>
</head>
<body>

<div class="card">
  <h1>ğŸ Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</h1>

  <div>
    <label>Ø§Ø³Ù…Ùƒ:</label>
    <input id="nameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
    <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  </div>

  <hr>

  <div id="raceStatus" class="mono">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¨Ø§Ù‚â€¦</div>

  <h3 id="questionText">â€”</h3>
  <div id="options"></div>

  <div id="msg"></div>
</div>

<script type="module">
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
  authDomain: "jawad-race.firebaseapp.com",
  projectId: "jawad-race",
  storageBucket: "jawad-race.firebasestorage.app",
  messagingSenderId: "677185572718",
  appId: "1:677185572718:web:91c4674236efce1d6efb7f"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, collection, addDoc,
  onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ================= REFERENCES ================= */
const raceRef      = doc(db, "race", "current");
const questionsCol = collection(db, "questions");
const playersCol   = collection(db, "players");
const answersCol   = collection(db, "answers");

/* ================= STATE ================= */
let currentQuestionId = null;
let questionShownAt   = null;

/* ================= HELPERS ================= */
const $ = id => document.getElementById(id);
const msg = (t,c="") => $("msg").innerHTML = `<div class="${c}">${t}</div>`;

/* ================= REGISTER ================= */
window.register = async () => {
  const name = $("nameInput").value.trim();
  if(!name){ msg("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ","err"); return; }

  localStorage.setItem("playerName", name);
  await addDoc(playersCol, {
    name,
    createdAt: serverTimestamp()
  });

  msg("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„","ok");
};

/* ================= RACE LISTENER ================= */
onSnapshot(raceRef, snap => {
  if(!snap.exists()) return;

  const r = snap.data();
  $("raceStatus").textContent =
    `status=${r.status} | index=${r.questionIndex}`;

  if(r.activeQuestionId){
    loadQuestion(r.activeQuestionId);
  }
});

/* ================= LOAD QUESTION ================= */
async function loadQuestion(qid){
  if(qid === currentQuestionId) return;
  currentQuestionId = qid;

  const qRef = doc(db,"questions",qid);
  onSnapshot(qRef, qsnap => {
    if(!qsnap.exists()){
      msg("âŒ Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","err");
      return;
    }

    const q = qsnap.data();
    $("questionText").textContent = q.text || q.question || "â€”";
    $("options").innerHTML = "";

    questionShownAt = Date.now();

    const opts = q.options || [
      q.option1,q.option2,q.option3,q.option4
    ];

    opts.forEach((opt,i)=>{
      if(!opt) return;
      const b = document.createElement("button");
      b.className="opt";
      b.textContent = opt;
      b.onclick = ()=>submitAnswer(qid,opt,i);
      $("options").appendChild(b);
    });
  });
}

/* ================= SUBMIT ANSWER ================= */
async function submitAnswer(qid, optionText, optionIndex){
  const name = localStorage.getItem("playerName");
  if(!name){ msg("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„","err"); return; }

  const timeMs = questionShownAt
    ? Date.now() - questionShownAt
    : null;

  await addDoc(answersCol,{
    questionId: qid,
    playerName: name,
    optionText,
    optionIndex,
    timeMs,
    createdAt: serverTimestamp()
  });

  msg("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©","ok");
}
</script>
</body>
</html>
