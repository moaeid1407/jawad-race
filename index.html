<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>سباق الإمام الجواد عليه السلام</title>

  <style>
    :root{
      --bg:#071c1b;
      --panel:#0e2a28;
      --accent:#f59e0b;
      --green:#22c55e;
      --text:#ffffff;
      --muted:rgba(255,255,255,.7);
      --dash:rgba(34,197,94,.55);
      --danger:#ef4444;
      --card: rgba(14,42,40,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: 26px 14px;
    }
    .wrap{ width: min(920px, 100%); text-align:center; }
    h1{ margin: 10px 0 6px; font-size: clamp(28px, 4vw, 44px); }
    .sub{ margin:0 0 14px; color: var(--muted); font-size: 16px; }

    .banner{
      border: 2px dashed var(--dash);
      border-radius: 18px;
      padding: 14px 14px;
      margin: 14px auto 14px;
      background: rgba(14,42,40,.28);
      color: var(--green);
      font-size: clamp(16px, 2.1vw, 20px);
      line-height:1.7;
      width: min(780px, 100%);
      text-align:center;
    }

    .card{
      width:min(780px, 100%);
      margin: 0 auto;
      background: var(--card);
      border-radius: 22px;
      padding: 16px 16px 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }

    input{
      width: min(560px, 100%);
      padding: 14px 14px;
      border-radius: 14px;
      border: 0;
      outline: none;
      font-size: 18px;
      text-align:center;
      margin-top: 6px;
    }

    .hint{
      margin: 10px 0 12px;
      color: var(--muted);
      font-size: 14px;
    }

    .btns{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    button{
      border:0;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 16px;
      cursor:pointer;
      background: var(--accent);
      color:#111;
      font-weight:800;
      min-width: 170px;
    }
    button.secondary{
      background: rgba(255,255,255,.12);
      color: #fff;
      border: 1px solid rgba(255,255,255,.18);
      font-weight:700;
    }
    button.danger{
      background: var(--danger);
      color:#fff;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .timerRow{
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 14px;
      align-items:center;
    }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.85);
      font-size: 13px;
      white-space:nowrap;
    }
    .bigTimer{
      font-size: clamp(44px, 7vw, 72px);
      font-weight: 900;
      letter-spacing: 1px;
      margin: 0;
      color: #fff;
    }

    /* Question box */
    .qBox{
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      text-align:right;
    }
    .qTitle{
      font-size: 18px;
      font-weight: 900;
      margin: 0 0 10px;
      line-height:1.8;
    }
    .options{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .opt{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease;
    }
    .opt:active{ transform: scale(.99); }
    .opt input{ width:auto; margin:0; }
    .opt span{ line-height:1.7; }

    .status{
      margin-top: 10px;
      font-weight: 900;
      text-align:center;
      display:none;
    }
    .ok{ color: var(--green); }
    .warn{ color: #fbbf24; }

    /* Admin panels */
    .adminGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
      text-align:right;
    }
    .adminBox{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 14px;
    }
    .adminTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .adminTitle h3{
      margin:0;
      font-size: 18px;
    }
    .list{
      max-height: 280px;
      overflow:auto;
      padding: 10px;
      background: rgba(255,255,255,.06);
      border-radius: 12px;
      text-align:right;
    }
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 8px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 14px;
    }
    .row:last-child{border-bottom:0}
    .muted{color: rgba(255,255,255,.7)}
    .small{
      font-size:12px;
      color: rgba(255,255,255,.70);
      margin-top: 8px;
      text-align:right;
      line-height:1.7;
    }
    .footer{
      margin-top: 10px;
      color: rgba(255,255,255,.65);
      font-size: 13px;
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>سباق الإمام الجواد عليه السلام</h1>
    <p class="sub">مسابقة تفاعلية — إشراف لجنة منابر النور بالجفر</p>

    <div id="banner" class="banner">⏳ بانتظار بدء الكويز من المنظم</div>

    <div class="card">

      <!-- PLAYER UI -->
      <div id="playerUI">
        <input id="playerName" placeholder="اكتب اسمك الثلاثي فقط" autocomplete="off" />
        <div class="hint">اضغط <b>تسجيل</b> بعد كتابة الاسم</div>

        <div class="btns">
          <button id="joinBtn">تسجيل</button>
        </div>

        <div class="timerRow">
          <div class="pill" id="phasePill">الحالة: انتظار</div>
          <div class="pill" id="qPill">السؤال: -</div>
        </div>

        <p class="bigTimer" id="countdown">00</p>

        <div id="questionBox" class="qBox" style="display:none;">
          <div class="qTitle" id="qText"></div>
          <div class="options" id="qOptions"></div>
          <div class="btns" style="justify-content:center;">
            <button id="submitBtn" class="secondary">إرسال الإجابة</button>
          </div>
          <div id="playerStatus" class="status warn"></div>
        </div>
      </div>

      <!-- ADMIN UI -->
      <div id="adminUI" style="display:none;">
        <div class="btns">
          <button id="adminStartQuiz">▶️ ابدأ الكويز (10 أسئلة)</button>
          <button id="adminResetQuiz" class="danger">♻️ تصفير كل شيء</button>
        </div>

        <div class="timerRow">
          <div class="pill" id="adminPhase">الحالة: -</div>
          <div class="pill" id="adminQ">السؤال: -</div>
          <div class="pill" id="adminPlayersCount">0 متسابق</div>
        </div>

        <p class="bigTimer" id="adminCountdown">00</p>

        <div class="adminGrid">
          <div class="adminBox">
            <div class="adminTitle">
              <h3>المتسابقون</h3>
              <div class="pill" id="playersPill">0</div>
            </div>
            <div class="list" id="playersList"></div>
            <div class="small">✅ التسجيل من الجوال يظهر هنا لايف.</div>
          </div>

          <div class="adminBox">
            <div class="adminTitle">
              <h3>الترتيب (الأصح ثم الأسرع)</h3>
              <div class="pill" id="rankPill">0</div>
            </div>
            <div class="list" id="rankList"></div>
            <div class="small">
              ✅ الترتيب = عدد الإجابات الصحيحة DESC ثم مجموع أزمنة الإجابات الصحيحة ASC.
            </div>
          </div>
        </div>
      </div>

      <div class="footer">«اللهم ارزقنا توفيق الطاعة، وبعد المعصية، وصدق النية» — الإمام الجواد (ع)</div>
    </div>
  </div>

<script>
/* =========================
   0) إعدادات الكويز
   ========================= */
const TOTAL_QUESTIONS = 10;          // عدد الأسئلة
const QUESTION_DURATION_SEC = 20;    // مدة كل سؤال (عدّلها مثلًا 15 أو 25)
const BREAK_DURATION_SEC = 3;        // فاصل بسيط بين الأسئلة

/* =========================
   1) Firebase Config (جاهز)
   ========================= */
firebase.initializeApp({
  apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
  authDomain: "jawad-race.firebaseapp.com",
  projectId: "jawad-race",
  storageBucket: "jawad-race.firebasestorage.app",
  messagingSenderId: "677185572718",
  appId: "1:677185572718:web:91c4674236efce1d6efb7f"
});

const db = firebase.firestore();

/* =========================
   2) مراجع Firestore
   ========================= */
const RACE_ID = "current";
const raceRef = db.collection("races").doc(RACE_ID);
const playersRef = db.collection("players");
const questionsRef = db.collection("questions");      // لازم فيها 10 أسئلة بحقل order
const responsesRef = raceRef.collection("responses"); // كل الإجابات هنا

/* =========================
   3) تحديد Admin/Player
   ========================= */
const isAdmin = new URLSearchParams(location.search).get("admin") === "1";

/* =========================
   4) عناصر الواجهة
   ========================= */
const banner = document.getElementById("banner");

const playerUI = document.getElementById("playerUI");
const adminUI  = document.getElementById("adminUI");

const playerName = document.getElementById("playerName");
const joinBtn = document.getElementById("joinBtn");

const phasePill = document.getElementById("phasePill");
const qPill = document.getElementById("qPill");
const countdown = document.getElementById("countdown");

const questionBox = document.getElementById("questionBox");
const qText = document.getElementById("qText");
const qOptions = document.getElementById("qOptions");
const submitBtn = document.getElementById("submitBtn");
const playerStatus = document.getElementById("playerStatus");

const adminStartQuiz = document.getElementById("adminStartQuiz");
const adminResetQuiz = document.getElementById("adminResetQuiz");
const adminPhase = document.getElementById("adminPhase");
const adminQ = document.getElementById("adminQ");
const adminPlayersCount = document.getElementById("adminPlayersCount");
const adminCountdown = document.getElementById("adminCountdown");

const playersList = document.getElementById("playersList");
const playersPill = document.getElementById("playersPill");

const rankList = document.getElementById("rankList");
const rankPill = document.getElementById("rankPill");

/* =========================
   5) وضع الواجهة
   ========================= */
if(isAdmin){
  playerUI.style.display = "none";
  adminUI.style.display  = "block";
} else {
  playerUI.style.display = "block";
  adminUI.style.display  = "none";
}

/* =========================
   6) حفظ اللاعب محلياً
   ========================= */
function getLocalPlayer(){
  return {
    name: localStorage.getItem("jr_playerName") || "",
    id: localStorage.getItem("jr_playerId") || ""
  };
}
function setLocalPlayer(name, id){
  localStorage.setItem("jr_playerName", name);
  localStorage.setItem("jr_playerId", id);
}
(function restorePlayer(){
  if(isAdmin) return;
  const p = getLocalPlayer();
  if(p.name){
    playerName.value = p.name;
    playerName.disabled = true;
    joinBtn.disabled = true;
  }
})();

/* =========================
   7) تسجيل المتسابق
   ========================= */
async function joinRace(){
  const name = (playerName.value || "").trim();
  if(name.length < 5){
    alert("اكتب الاسم الثلاثي بشكل صحيح");
    return;
  }

  joinBtn.disabled = true;

  // منع تكرار نفس الاسم في نفس السباق
  const exists = await playersRef
    .where("raceId","==",RACE_ID)
    .where("name","==",name)
    .limit(1)
    .get();

  if(!exists.empty){
    const first = exists.docs[0];
    setLocalPlayer(name, first.id);
    alert("هذا الاسم مسجل مسبقًا ✅");
    playerName.disabled = true;
    joinBtn.disabled = true;
    return;
  }

  const docRef = await playersRef.add({
    name,
    raceId: RACE_ID,
    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  setLocalPlayer(name, docRef.id);

  alert("تم التسجيل ✅ انتظر بدء الكويز");
  playerName.disabled = true;
  joinBtn.disabled = true;
}
joinBtn?.addEventListener("click", joinRace);
playerName?.addEventListener("keypress", (e)=>{ if(e.key==="Enter") joinRace(); });

/* =========================
   8) Helper: تنسيق الثواني
   ========================= */
function two(n){ return String(Math.max(0, Math.floor(n))).padStart(2,"0"); }
function setCountdown(sec){
  const v = two(sec);
  countdown.textContent = v;
  adminCountdown.textContent = v;
}

/* =========================
   9) تحميل سؤال حسب order
   ========================= */
async function getQuestionByOrder(order){
  const snap = await questionsRef.where("order","==",order).limit(1).get();
  if(snap.empty) return null;
  return { id: snap.docs[0].id, ...snap.docs[0].data() };
}

/* =========================
   10) Player: عرض السؤال
   ========================= */
let selectedIndex = null;
let currentOrder = null;
let currentQId = null;
let currentStartMs = null;

function renderQuestion(q, order){
  currentQId = q.id;
  currentOrder = order;
  qText.textContent = q.text || "";
  qOptions.innerHTML = "";
  selectedIndex = null;

  (q.options || []).forEach((txt, idx)=>{
    const label = document.createElement("label");
    label.className = "opt";
    label.innerHTML = `
      <input type="radio" name="ans" value="${idx}">
      <span>${txt}</span>
    `;
    label.addEventListener("click", ()=>{
      selectedIndex = idx;
      const radio = label.querySelector("input");
      if(radio) radio.checked = true;
    });
    qOptions.appendChild(label);
  });

  playerStatus.style.display = "none";
  questionBox.style.display = "block";
}

function hideQuestion(){
  questionBox.style.display = "none";
  selectedIndex = null;
}

/* =========================
   11) Player: إرسال الإجابة
   ========================= */
async function submitAnswer(){
  const p = getLocalPlayer();
  if(!p.name){
    alert("سجل اسمك أولاً");
    return;
  }
  if(!currentQId || !currentOrder || !currentStartMs){
    alert("لا يوجد سؤال نشط الآن");
    return;
  }
  if(selectedIndex === null){
    alert("اختر إجابة أولاً");
    return;
  }

  submitBtn.disabled = true;

  const nowMs = Date.now();
  const timeMs = Math.max(0, nowMs - currentStartMs);

  // حفظ الإجابة (نمنع تكرار نفس اللاعب لنفس السؤال: docId = playerId_order)
  const docId = `${p.id || p.name}_${currentOrder}`;

  await responsesRef.doc(docId).set({
    playerId: p.id || null,
    playerName: p.name,
    order: currentOrder,
    questionId: currentQId,
    answerIndex: selectedIndex,
    timeMs: timeMs,
    answeredAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  playerStatus.textContent = "تم إرسال إجابتك ✅";
  playerStatus.className = "status ok";
  playerStatus.style.display = "block";
  submitBtn.disabled = false;
}
submitBtn?.addEventListener("click", submitAnswer);

/* =========================
   12) تشغيل العد التنازلي محلياً حسب endAt
   ========================= */
let countdownInterval = null;
function stopCountdownTick(){
  if(countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
}
function startCountdownTick(endAtMs){
  stopCountdownTick();
  const tick = ()=>{
    const left = Math.ceil((endAtMs - Date.now())/1000);
    setCountdown(left);
  };
  tick();
  countdownInterval = setInterval(tick, 250);
}

/* =========================
   13) الاستماع لحالة السباق (يوصل للجميع)
   races/current:
   {
     quizStatus: "waiting"|"question"|"break"|"finished",
     currentOrder: number,
     questionId: string|null,
     questionStartAt: timestamp|null,
     questionEndAt: timestamp|null
   }
   ========================= */
raceRef.onSnapshot(async (doc)=>{
  if(!doc.exists){
    await raceRef.set({
      quizStatus: "waiting",
      currentOrder: 0,
      questionId: null,
      questionStartAt: null,
      questionEndAt: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return;
  }

  const d = doc.data() || {};
  const status = d.quizStatus || "waiting";
  const order = d.currentOrder || 0;

  const startAtMs = d.questionStartAt?.toDate ? d.questionStartAt.toDate().getTime() : null;
  const endAtMs = d.questionEndAt?.toDate ? d.questionEndAt.toDate().getTime() : null;

  // تحديث واجهات الحالة
  const statusLabel =
    status === "waiting" ? "انتظار" :
    status === "question" ? "سؤال" :
    status === "break" ? "انتقال" :
    status === "finished" ? "انتهى" : status;

  phasePill.textContent = `الحالة: ${statusLabel}`;
  adminPhase.textContent = `الحالة: ${statusLabel}`;

  qPill.textContent = order ? `السؤال: ${order}/${TOTAL_QUESTIONS}` : "السؤال: -";
  adminQ.textContent = order ? `السؤال: ${order}/${TOTAL_QUESTIONS}` : "السؤال: -";

  // البانر
  if(status === "waiting"){
    banner.style.display = "block";
    banner.textContent = "⏳ بانتظار بدء الكويز من المنظم";
    hideQuestion();
    stopCountdownTick();
    setCountdown(0);
  } else if(status === "break"){
    banner.style.display = "block";
    banner.textContent = "⏳ انتظر… انتقال للسؤال التالي";
    hideQuestion();
    if(endAtMs) startCountdownTick(endAtMs);
  } else if(status === "finished"){
    banner.style.display = "block";
    banner.textContent = "✅ انتهى الكويز — راجع الترتيب عند المتحكم";
    hideQuestion();
    stopCountdownTick();
    setCountdown(0);
  } else if(status === "question"){
    banner.style.display = "none";
    if(endAtMs) startCountdownTick(endAtMs);
  }

  // Player: عندما يصبح status=question، اجلب السؤال واعرضه
  if(!isAdmin){
    if(status !== "question"){
      return;
    }
    if(!d.questionId || !order || !startAtMs){
      return;
    }

    // خزّن وقت بداية السؤال محلياً لحساب timeMs
    currentStartMs = startAtMs;

    // جلب السؤال من questions بالـ questionId
    const qDoc = await questionsRef.doc(d.questionId).get();
    if(!qDoc.exists){
      hideQuestion();
      return;
    }
    renderQuestion({ id: qDoc.id, ...qDoc.data() }, order);

    // رسالة إذا اللاعب حاول يجاوب مرتين
    playerStatus.style.display = "none";
  }
});

/* =========================
   14) Admin: عرض المتسابقين
   ========================= */
if(isAdmin){
  playersRef.where("raceId","==",RACE_ID).orderBy("joinedAt","asc").onSnapshot((snap)=>{
    const arr = [];
    snap.forEach(doc => arr.push({id: doc.id, ...doc.data()}));
    adminPlayersCount.textContent = `${arr.length} متسابق`;
    playersPill.textContent = `${arr.length}`;

    playersList.innerHTML = arr.length ? "" : `<div class="muted">لا يوجد متسابقين مسجلين بعد…</div>`;
    arr.forEach((p, idx)=>{
      const joined = p.joinedAt?.toDate ? p.joinedAt.toDate() : null;
      const time = joined ? joined.toLocaleTimeString("ar-SA") : "--:--";
      const div = document.createElement("div");
      div.className = "row";
      div.innerHTML = `<div>${idx+1}) ${p.name}</div><div class="muted">${time}</div>`;
      playersList.appendChild(div);
    });
  });
}

/* =========================
   15) Admin: حساب الترتيب لايف من responses
   ========================= */
function renderRanking(map){
  // map: playerName -> { correct, timeCorrectMs, totalAnswered }
  const arr = Object.values(map);

  // الترتيب: correct desc ثم timeCorrectMs asc
  arr.sort((a,b)=>{
    if(b.correct !== a.correct) return b.correct - a.correct;
    return a.timeCorrectMs - b.timeCorrectMs;
  });

  rankPill.textContent = `${arr.length}`;
  rankList.innerHTML = arr.length ? "" : `<div class="muted">لم تبدأ الإجابات بعد…</div>`;

  arr.forEach((p, i)=>{
    const sec = Math.round(p.timeCorrectMs/1000);
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div>${i+1}) ${p.playerName}</div>
      <div class="muted">صح: <b>${p.correct}</b> — زمن: <b>${sec}s</b></div>
    `;
    rankList.appendChild(div);
  });
}

if(isAdmin){
  // نحتاج نعرف الصحيح/الخطأ: نجيب الأسئلة مرة ونحطها في قاموس (order -> correctIndex)
  let correctByOrder = {};
  questionsRef.onSnapshot((snap)=>{
    const map = {};
    snap.forEach(d=>{
      const q = d.data();
      if(typeof q.order === "number" && typeof q.correctIndex === "number"){
        map[q.order] = q.correctIndex;
      }
    });
    correctByOrder = map;
  });

  responsesRef.onSnapshot((snap)=>{
    const agg = {}; // key: playerId or name

    snap.forEach(d=>{
      const r = d.data();
      const key = r.playerId || r.playerName || d.id;
      if(!agg[key]){
        agg[key] = {
          playerName: r.playerName || "—",
          correct: 0,
          timeCorrectMs: 0,
          totalAnswered: 0
        };
      }
      agg[key].totalAnswered += 1;

      const correctIndex = correctByOrder[r.order];
      const isCorrect = (typeof correctIndex === "number") && (r.answerIndex === correctIndex);

      if(isCorrect){
        agg[key].correct += 1;
        agg[key].timeCorrectMs += (r.timeMs || 0);
      }
    });

    renderRanking(agg);
  });
}

/* =========================
   16) Admin: تشغيل الكويز تلقائياً (10 أسئلة)
   ========================= */
async function adminSetState(state){
  await raceRef.set(state, { merge: true });
}

// تشغيل سؤال رقم order (يجيب questionId من questions where order)
async function adminStartQuestion(order){
  const q = await getQuestionByOrder(order);
  if(!q){
    alert(`لا يوجد سؤال رقم ${order} داخل Collection questions (حقل order)`);
    return false;
  }

  // ضبط start/end بالـ server timestamp: نستخدم FieldValue.serverTimestamp للبداية
  // وللنهاية نستخدم حساب محلي + نرسل كـ Timestamp من JS (لازم Date)
  const startAt = new Date(); // سيُستخدم كسند لاحقاً للأجهزة، ولكن الأفضل serverTimestamp للبداية
  const endAt = new Date(Date.now() + QUESTION_DURATION_SEC * 1000);

  await raceRef.set({
    quizStatus: "question",
    currentOrder: order,
    questionId: q.id,
    questionStartAt: firebase.firestore.FieldValue.serverTimestamp(),
    questionEndAt: firebase.firestore.Timestamp.fromDate(endAt),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  return true;
}

async function adminStartBreak(nextOrder){
  const endAt = new Date(Date.now() + BREAK_DURATION_SEC * 1000);
  await raceRef.set({
    quizStatus: "break",
    currentOrder: nextOrder - 1,
    questionId: null,
    questionStartAt: null,
    questionEndAt: firebase.firestore.Timestamp.fromDate(endAt),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminFinish(){
  await raceRef.set({
    quizStatus: "finished",
    questionId: null,
    questionStartAt: null,
    questionEndAt: null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminClearAll(){
  // تصفير السباق + حذف كل responses
  const batch = db.batch();

  batch.set(raceRef, {
    quizStatus: "waiting",
    currentOrder: 0,
    questionId: null,
    questionStartAt: null,
    questionEndAt: null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  const resp = await responsesRef.get();
  resp.forEach(doc => batch.delete(doc.ref));

  await batch.commit();
}

// “ابدأ الكويز” = يدور تلقائي: سؤال 1 → فاصل → سؤال 2… إلى 10 → finished
let adminRunning = false;

async function adminRunQuiz(){
  if(adminRunning) return;
  adminRunning = true;

  // تأكد من وجود 10 أسئلة
  const qsSnap = await questionsRef.get();
  if(qsSnap.size < TOTAL_QUESTIONS){
    adminRunning = false;
    alert(`لازم يكون عندك على الأقل ${TOTAL_QUESTIONS} أسئلة داخل Collection questions`);
    return;
  }

  // ابدأ من 1
  for(let order=1; order<=TOTAL_QUESTIONS; order++){
    // سؤال
    const ok = await adminStartQuestion(order);
    if(!ok){ adminRunning = false; return; }

    // انتظر مدة السؤال
    await new Promise(res => setTimeout(res, QUESTION_DURATION_SEC * 1000));

    // فاصل (إلا بعد آخر سؤال)
    if(order < TOTAL_QUESTIONS){
      await adminStartBreak(order+1);
      await new Promise(res => setTimeout(res, BREAK_DURATION_SEC * 1000));
    }
  }

  await adminFinish();
  adminRunning = false;
}

if(isAdmin){
  adminStartQuiz.addEventListener("click", adminRunQuiz);
  adminResetQuiz.addEventListener("click", async ()=>{
    adminRunning = false;
    await adminClearAll();
    alert("تم التصفير ✅");
  });
}
</script>

</body>
</html>
