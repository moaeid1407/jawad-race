<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</title>

  <style>
    :root{
      --bg:#071c1b;
      --panel:#0e2a28;
      --accent:#f59e0b;
      --green:#22c55e;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --dash:rgba(34,197,94,.55);
      --danger:#ef4444;
      --card: rgba(14,42,40,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: 28px 14px;
    }
    .wrap{
      width: min(920px, 100%);
      text-align:center;
    }
    h1{
      margin: 10px 0 6px;
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing:.3px;
    }
    .sub{
      margin:0 0 14px;
      color: var(--muted);
      font-size: 15px;
    }

    .waiting{
      border: 2px dashed var(--dash);
      border-radius: 18px;
      padding: 16px 14px;
      margin: 14px auto 16px;
      background: rgba(14,42,40,.35);
      color: var(--green);
      font-size: clamp(16px, 2.1vw, 22px);
      line-height:1.7;
      width: min(760px, 100%);
    }

    .card{
      width:min(860px, 100%);
      margin: 0 auto;
      background: var(--card);
      border-radius: 22px;
      padding: 18px 16px 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }

    input{
      width: min(560px, 100%);
      padding: 14px 14px;
      border-radius: 14px;
      border: 0;
      outline: none;
      font-size: 18px;
      text-align:center;
      margin-top: 6px;
    }

    .hint{
      margin: 10px 0 12px;
      color: var(--muted);
      font-size: 13px;
    }

    .btns{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    button{
      border:0;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 15px;
      cursor:pointer;
      background: var(--accent);
      color:#111;
      font-weight:800;
      min-width: 150px;
    }
    button.secondary{
      background: rgba(255,255,255,.12);
      color: #fff;
      border: 1px solid rgba(255,255,255,.18);
      font-weight:700;
    }
    button.danger{
      background: var(--danger);
      color:#fff;
    }
    button:disabled{opacity:.55;cursor:not-allowed}

    .timer{
      font-size: clamp(52px, 8vw, 78px);
      margin: 10px 0 6px;
      font-weight: 900;
      letter-spacing: 1px;
    }

    /* Question UI */
    .qBox{
      margin: 14px auto 0;
      width: min(760px, 100%);
      text-align:right;
      padding: 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
    }
    .qTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .qNum{
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(245,158,11,.15);
      border: 1px solid rgba(245,158,11,.35);
      color: #ffd38a;
      font-size: 12px;
      white-space:nowrap;
    }
    .qText{
      font-size: 18px;
      line-height: 1.7;
      margin: 6px 0 10px;
      text-align:right;
    }
    .opts{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .optBtn{
      width:100%;
      text-align:right;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
      font-weight:700;
      padding: 12px 12px;
      border-radius: 14px;
      cursor:pointer;
    }
    .optBtn:hover{background: rgba(255,255,255,.14)}
    .optBtn:disabled{opacity:.6; cursor:not-allowed}
    .statusLine{
      margin-top:10px;
      color: rgba(255,255,255,.78);
      font-size: 13px;
      line-height:1.6;
    }
    .ok{color: var(--green); font-weight:900}
    .bad{color: #ffb4b4; font-weight:900}

    /* Admin panel */
    .adminGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top: 14px;
      text-align:right;
    }
    @media (max-width:900px){
      .adminGrid{grid-template-columns:1fr}
    }
    .adminBox{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 14px;
    }
    .adminTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .adminTitle h3{
      margin:0;
      font-size: 16px;
    }
    .pill{
      padding:6px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(34,197,94,.15);
      color: var(--green);
      border: 1px solid rgba(34,197,94,.35);
      white-space:nowrap;
    }
    .list{
      max-height: 260px;
      overflow:auto;
      padding: 10px;
      background: rgba(255,255,255,.06);
      border-radius: 12px;
      text-align:right;
    }
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 8px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 14px;
    }
    .row:last-child{border-bottom:0}
    .muted{color: rgba(255,255,255,.7)}
    .small{
      font-size:12px;
      color: rgba(255,255,255,.70);
      margin-top: 8px;
      text-align:right;
      line-height:1.7;
    }

    .footer{
      margin-top: 10px;
      color: rgba(255,255,255,.65);
      font-size: 13px;
    }
  </style>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</h1>
    <p class="sub">Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© â€” Ø¥Ø´Ø±Ø§Ù Ù„Ø¬Ù†Ø© Ù…Ù†Ø§Ø¨Ø± Ø§Ù„Ù†ÙˆØ± Ø¨Ø§Ù„Ø¬ÙØ±</p>

    <div id="waitingMessage" class="waiting">
      â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…<br/>
      ğŸš¦ Ø§Ø³ØªØ¹Ø¯ÙˆØ§
    </div>

    <div class="card">
      <!-- PLAYER UI -->
      <div id="playerUI">
        <div id="joinArea">
          <input id="playerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙÙ‚Ø·" autocomplete="off" />
          <div class="hint">Ø§Ø¶ØºØ· <b>ØªØ³Ø¬ÙŠÙ„</b> Ø¨Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…</div>
          <div class="btns">
            <button id="joinBtn">ØªØ³Ø¬ÙŠÙ„</button>
          </div>
        </div>

        <div class="timer" id="timer">00:00</div>

        <div id="questionBox" class="qBox" style="display:none;">
          <div class="qTop">
            <div class="qNum" id="qNumPill">Ø³Ø¤Ø§Ù„</div>
            <div class="muted" id="qLiveHint">Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§â€¦</div>
          </div>
          <div class="qText" id="qText">â€”</div>
          <div class="opts" id="opts"></div>
          <div class="statusLine" id="answerStatus"></div>
        </div>
      </div>

      <!-- ADMIN UI -->
      <div id="adminUI" style="display:none;">
        <div class="btns">
          <button id="adminStartBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
          <button class="secondary" id="adminStopBtn">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù / Ù…ØªØ§Ø¨Ø¹Ø©</button>
          <button class="danger" id="adminResetBtn">â™»ï¸ ØªØµÙÙŠØ±</button>
        </div>

        <div class="btns" style="margin-top:8px;">
          <button class="secondary" id="prevQBtn">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button id="nextQBtn">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
        </div>

        <div class="timer" id="adminTimer">00:00</div>

        <div class="adminGrid">
          <div class="adminBox">
            <div class="adminTitle">
              <h3>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙˆÙ†</h3>
              <div class="pill" id="countPill">0 Ù…ØªØ³Ø§Ø¨Ù‚</div>
            </div>
            <div class="list" id="playersList"></div>
            <div class="small">
              âœ… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªÙØ³Ø­Ø¨ Ù„Ø§ÙŠÙ Ù…Ù† Firestore.<br/>
              âœ… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ ÙŠØ³Ø¬Ù„ Ù…Ù† Ø¬ÙˆØ§Ù„Ù‡ ÙˆÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯Ùƒ Ù‡Ù†Ø§ ÙÙˆØ±Ù‹Ø§.
            </div>
          </div>

          <div class="adminBox">
            <div class="adminTitle">
              <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ (Ù„Ø§ÙŠÙ)</h3>
              <div class="pill" id="rankPill">0 Ù„Ø§Ø¹Ø¨</div>
            </div>
            <div class="list" id="rankList"></div>
            <div class="small">
              ğŸ”¥ Ø§Ù„ØªØ±ØªÙŠØ¨ = (Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©) Ø«Ù… (Ù…Ø¬Ù…ÙˆØ¹ Ø²Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© Ø§Ù„Ø£Ù‚Ù„).<br/>
              âš ï¸ Ù„Ø§Ø²Ù… Ø£Ø³Ø¦Ù„Ø© `questions` ÙÙŠÙ‡Ø§ correctIndex.
            </div>
          </div>
        </div>

        <div class="footer">Â«Ø§Ù„Ù„Ù‡Ù… Ø§Ø±Ø²Ù‚Ù†Ø§ ØªÙˆÙÙŠÙ‚ Ø§Ù„Ø·Ø§Ø¹Ø©ØŒ ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹ØµÙŠØ©ØŒ ÙˆØµØ¯Ù‚ Ø§Ù„Ù†ÙŠØ©Â» â€” Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)</div>
      </div>
    </div>
  </div>

<script>
/* =========================
   1) Firebase Config (Ø¬Ø§Ù‡Ø²)
   ========================= */
firebase.initializeApp({
  apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
  authDomain: "jawad-race.firebaseapp.com",
  projectId: "jawad-race",
  storageBucket: "jawad-race.firebasestorage.app",
  messagingSenderId: "677185572718",
  appId: "1:677185572718:web:91c4674236efce1d6efb7f"
});
const db = firebase.firestore();

/* =========================
   2) Collections/Refs
   ========================= */
const RACE_ID = "current";
const raceRef     = db.collection("races").doc(RACE_ID);
const playersRef  = db.collection("players");
const questionsRef= db.collection("questions");
const answersRef  = db.collection("answers");

/* =========================
   3) Admin or Player
   ========================= */
const qs = new URLSearchParams(location.search);
const isAdmin = qs.get("admin") === "1";

/* =========================
   4) Elements
   ========================= */
const waitingMessage = document.getElementById("waitingMessage");

const playerUI = document.getElementById("playerUI");
const adminUI  = document.getElementById("adminUI");

const joinArea   = document.getElementById("joinArea");
const playerName = document.getElementById("playerName");
const joinBtn    = document.getElementById("joinBtn");
const timerEl    = document.getElementById("timer");

const questionBox = document.getElementById("questionBox");
const qNumPill    = document.getElementById("qNumPill");
const qText       = document.getElementById("qText");
const opts        = document.getElementById("opts");
const answerStatus= document.getElementById("answerStatus");
const qLiveHint   = document.getElementById("qLiveHint");

const adminStartBtn = document.getElementById("adminStartBtn");
const adminStopBtn  = document.getElementById("adminStopBtn");
const adminResetBtn = document.getElementById("adminResetBtn");
const nextQBtn      = document.getElementById("nextQBtn");
const prevQBtn      = document.getElementById("prevQBtn");
const adminTimerEl  = document.getElementById("adminTimer");

const playersList = document.getElementById("playersList");
const countPill   = document.getElementById("countPill");

const rankList = document.getElementById("rankList");
const rankPill = document.getElementById("rankPill");

/* =========================
   5) UI Mode
   ========================= */
if(isAdmin){
  playerUI.style.display = "none";
  adminUI.style.display  = "block";
} else {
  playerUI.style.display = "block";
  adminUI.style.display  = "none";
}

/* =========================
   6) Timer (race global)
   ========================= */
let tickInterval = null;

function fmt(ms){
  const total = Math.max(0, Math.floor(ms/1000));
  const m = String(Math.floor(total/60)).padStart(2,"0");
  const s = String(total%60).padStart(2,"0");
  return `${m}:${s}`;
}
function stopTick(){
  if(tickInterval){ clearInterval(tickInterval); tickInterval = null; }
}
function startTick(startAtMs, paused){
  stopTick();
  const update = () => {
    if(paused) return;
    const now = Date.now();
    const diff = now - startAtMs;
    const t = fmt(diff);
    timerEl.textContent = t;
    adminTimerEl.textContent = t;
  };
  update();
  tickInterval = setInterval(update, 250);
}

/* =========================
   7) Load questions once
   ========================= */
let QUESTIONS = []; // [{id, order, question, options[], correctIndex}]
async function loadQuestions(){
  const snap = await questionsRef.orderBy("order","asc").get();
  QUESTIONS = snap.docs.map(d => ({ id:d.id, ...d.data() }))
                      .filter(x => typeof x.order === "number" && x.question && Array.isArray(x.options));
}
loadQuestions();

/* =========================
   8) Player session
   ========================= */
let myPlayerId = localStorage.getItem("jr_playerId") || null;
let myPlayerName = localStorage.getItem("jr_playerName") || "";

/* =========================
   9) Join player (create doc with known id)
   ========================= */
async function joinRace(){
  const name = (playerName.value || "").trim();
  if(name.length < 5){
    alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
    return;
  }

  joinBtn.disabled = true;

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù‡ playerId Ù‚Ø¯ÙŠÙ…ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
  if(!myPlayerId){
    myPlayerId = playersRef.doc().id; // generate id
  }

  await playersRef.doc(myPlayerId).set({
    name,
    raceId: RACE_ID,
    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  myPlayerName = name;
  localStorage.setItem("jr_playerId", myPlayerId);
  localStorage.setItem("jr_playerName", myPlayerName);

  joinArea.style.display = "none";
  alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ… Ø§Ù†ØªØ¸Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…");
}

joinBtn?.addEventListener("click", joinRace);
playerName?.addEventListener("keypress", (e)=>{ if(e.key==="Enter") joinRace(); });

/* Restore name if exists */
if(!isAdmin && myPlayerName){
  playerName.value = myPlayerName;
}

/* =========================
   10) Admin: list players live
   ========================= */
if(isAdmin){
  playersRef
    .where("raceId","==",RACE_ID)
    .orderBy("joinedAt","asc")
    .onSnapshot((snap)=>{
      const arr = [];
      snap.forEach(doc => arr.push({id: doc.id, ...doc.data()}));
      countPill.textContent = `${arr.length} Ù…ØªØ³Ø§Ø¨Ù‚`;
      playersList.innerHTML = arr.length ? "" : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯â€¦</div>`;
      arr.forEach((p, idx)=>{
        const joined = p.joinedAt?.toDate ? p.joinedAt.toDate() : null;
        const time = joined ? joined.toLocaleTimeString("ar-SA") : "--:--";
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `<div>${idx+1}) ${p.name}</div><div class="muted">${time}</div>`;
        playersList.appendChild(div);
      });
    });
}

/* =========================
   11) Question render + answer submit
   ========================= */
let currentQOrder = null;
let currentQStartAtMs = null;
let answeredFor = new Set(); // local cache to disable multiple answers per question

function clearOptions(){
  opts.innerHTML = "";
  answerStatus.textContent = "";
}

function renderQuestion(q){
  questionBox.style.display = "block";
  qNumPill.textContent = `Ø³Ø¤Ø§Ù„ ${q.order} / ${QUESTIONS.length}`;
  qText.textContent = q.question;
  clearOptions();

  q.options.forEach((txt, idx)=>{
    const b = document.createElement("button");
    b.className = "optBtn";
    b.textContent = `${idx+1}) ${txt}`;
    b.disabled = !myPlayerId || answeredFor.has(q.order);
    b.addEventListener("click", ()=> submitAnswer(q, idx));
    opts.appendChild(b);
  });

  if(!myPlayerId){
    answerStatus.innerHTML = `<span class="bad">Ø³Ø¬Ù‘Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹</span> Ø«Ù… Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø£Ø²Ø±Ø§Ø±.`;
  } else if(answeredFor.has(q.order)){
    answerStatus.innerHTML = `<span class="ok">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨ØªÙƒ âœ…</span> Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠâ€¦`;
  } else {
    answerStatus.innerHTML = `Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø¢Ù† ğŸ‘‡`;
  }
}

async function submitAnswer(q, selectedIndex){
  if(!myPlayerId) return;
  if(answeredFor.has(q.order)) return;

  // lock buttons
  answeredFor.add(q.order);
  Array.from(opts.querySelectorAll("button")).forEach(b=> b.disabled = true);
  answerStatus.innerHTML = `Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦`;

  const nowMs = Date.now();
  const responseMs = currentQStartAtMs ? Math.max(0, nowMs - currentQStartAtMs) : null;
  const correct = (selectedIndex === q.correctIndex);

  await answersRef.add({
    raceId: RACE_ID,
    playerId: myPlayerId,
    playerName: myPlayerName || "",
    questionOrder: q.order,
    selectedIndex,
    correct,
    responseMs,
    answeredAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  answerStatus.innerHTML = correct
    ? `<span class="ok">ØµØ­ÙŠØ­ âœ…</span> ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.`
    : `<span class="bad">ØºÙŠØ± ØµØ­ÙŠØ­ âŒ</span> ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.`;
}

/* =========================
   12) Race state listener (status + activeQuestionOrder)
   races/current:
   {
     status: "waiting|running",
     paused: bool,
     startAt: timestamp,
     activeQuestionOrder: number|null,
     questionStartAt: timestamp|null
   }
   ========================= */
raceRef.onSnapshot(async (doc)=>{
  if(!doc.exists){
    await raceRef.set({
      status: "waiting",
      paused: false,
      startAt: null,
      activeQuestionOrder: null,
      questionStartAt: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return;
  }

  const data = doc.data();
  const status = data.status || "waiting";
  const paused = !!data.paused;

  // global timer
  if(status === "waiting"){
    waitingMessage.style.display = "block";
    stopTick();
    timerEl.textContent = "00:00";
    adminTimerEl.textContent = "00:00";
  } else if(status === "running"){
    waitingMessage.style.display = "none";
    const startAt = data.startAt?.toDate ? data.startAt.toDate().getTime() : Date.now();
    startTick(startAt, paused);
  }

  // question state
  const aq = (typeof data.activeQuestionOrder === "number") ? data.activeQuestionOrder : null;
  currentQOrder = aq;

  currentQStartAtMs = data.questionStartAt?.toDate ? data.questionStartAt.toDate().getTime() : null;

  if(!QUESTIONS.length){
    // if questions not loaded yet, try reload
    await loadQuestions();
  }

  if(status !== "running"){
    // hide question for player while waiting
    if(!isAdmin){
      questionBox.style.display = "none";
    }
    return;
  }

  if(aq == null){
    // race running but no active question yet
    if(!isAdmin){
      questionBox.style.display = "block";
      qNumPill.textContent = `â€”`;
      qText.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…â€¦";
      clearOptions();
      qLiveHint.textContent = "Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§";
      answerStatus.textContent = "";
    }
    return;
  }

  const q = QUESTIONS.find(x => x.order === aq);
  if(!q){
    if(!isAdmin){
      questionBox.style.display = "block";
      qText.textContent = "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ Collection questions";
      clearOptions();
    }
    return;
  }

  // show question to players
  if(!isAdmin){
    qLiveHint.textContent = "Ø³Ø¤Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±";
    renderQuestion(q);
  }
});

/* =========================
   13) Admin buttons: start/pause/reset/next/prev
   ========================= */
async function adminStart(){
  await raceRef.set({
    status: "running",
    paused: false,
    startAt: firebase.firestore.FieldValue.serverTimestamp(),
    activeQuestionOrder: null,
    questionStartAt: null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminTogglePause(){
  const doc = await raceRef.get();
  const paused = !!doc.data()?.paused;
  await raceRef.set({
    paused: !paused,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminReset(){
  // ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¨Ø§Ù‚ + Ù…Ø³Ø­ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
  await raceRef.set({
    status: "waiting",
    paused: false,
    startAt: null,
    activeQuestionOrder: null,
    questionStartAt: null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function setActiveQuestion(order){
  // ÙŠØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø­Ù…Ù„Ø©
  if(!QUESTIONS.length) await loadQuestions();
  const max = QUESTIONS.length || 10;

  const clamped = Math.max(1, Math.min(max, order));

  await raceRef.set({
    status: "running",
    paused: false,
    activeQuestionOrder: clamped,
    questionStartAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminNext(){
  const doc = await raceRef.get();
  const cur = doc.data()?.activeQuestionOrder;
  const next = (typeof cur === "number") ? (cur + 1) : 1;
  await setActiveQuestion(next);
}
async function adminPrev(){
  const doc = await raceRef.get();
  const cur = doc.data()?.activeQuestionOrder;
  const prev = (typeof cur === "number") ? (cur - 1) : 1;
  await setActiveQuestion(prev);
}

if(isAdmin){
  adminStartBtn.addEventListener("click", adminStart);
  adminStopBtn.addEventListener("click", adminTogglePause);
  adminResetBtn.addEventListener("click", adminReset);
  nextQBtn.addEventListener("click", adminNext);
  prevQBtn.addEventListener("click", adminPrev);
}

/* =========================
   14) Admin: live ranking from answers
   ========================= */
function renderRanking(playersMap){
  const arr = Object.values(playersMap);

  // sort: correct desc, totalMs asc
  arr.sort((a,b)=>{
    if(b.correctCount !== a.correctCount) return b.correctCount - a.correctCount;
    return a.totalMs - b.totalMs;
  });

  rankPill.textContent = `${arr.length} Ù„Ø§Ø¹Ø¨`;

  rankList.innerHTML = arr.length ? "" : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯â€¦</div>`;
  arr.forEach((p, idx)=>{
    const div = document.createElement("div");
    div.className = "row";
    const ms = (p.totalMs === Infinity) ? "--" : `${p.totalMs}ms`;
    div.innerHTML = `
      <div>${idx+1}) ${p.name}</div>
      <div class="muted">${p.correctCount} âœ… | ${ms}</div>
    `;
    rankList.appendChild(div);
  });
}

if(isAdmin){
  // live answers for this race
  answersRef
    .where("raceId","==",RACE_ID)
    .onSnapshot((snap)=>{
      const map = {}; // playerId -> {name, correctCount, totalMs, answered}
      snap.forEach(d=>{
        const a = d.data();
        const pid = a.playerId || "unknown";
        if(!map[pid]){
          map[pid] = {
            name: a.playerName || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
            correctCount: 0,
            totalMs: 0,
            seen: new Set()
          };
        }
        // unique per question
        const qk = a.questionOrder;
        if(map[pid].seen.has(qk)) return;
        map[pid].seen.add(qk);

        if(a.correct) map[pid].correctCount += 1;
        if(typeof a.responseMs === "number"){
          map[pid].totalMs += a.responseMs;
        } else {
          // Ù„Ùˆ Ù…Ø§ ÙˆØµÙ„ Ø²Ù…Ù†ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ ÙƒØ¨ÙŠØ±
          map[pid].totalMs += 9999999;
        }
      });

      // clean sets for rendering
      Object.values(map).forEach(p=>{ p.seen = undefined; });

      renderRanking(map);
    });
}
</script>
</body>
</html>
