<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ุณุจุงู ุงูุฌูุงุฏ โ ุงููุชุณุงุจู</title>
  <style>
    body{font-family:system-ui,Segoe UI,Tahoma,Arial;background:#f6f7fb;margin:0;padding:22px}
    .wrap{max-width:820px;margin:auto}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.05);margin-bottom:12px}
    h1{margin:0 0 6px 0;font-size:26px}
    .sub{color:#666;margin-bottom:14px}
    input,button{width:100%;padding:12px;border-radius:12px;border:1px solid #d7dbe6;font-size:16px}
    button{cursor:pointer}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .big{font-size:20px;font-weight:800}
    .muted{color:#666}
    .ok{color:#16a34a;font-weight:800}
    .warn{color:#b45309;font-weight:800}
    .err{color:#dc2626;font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;color:#444;white-space:pre-wrap}
    ul{margin:8px 0 0 0;padding:0 18px}
    a{color:#2563eb;text-decoration:none}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <h1>๐ ุณุจุงู ุงูุฌูุงุฏ โ ุงููุชุณุงุจู</h1>
        <div class="sub">ุณุฌูู ุงุณููุ ุซู ุงูุชุธุฑ ุงูููุธู ูุถุบุท (ุงูุณุคุงู ุงูุชุงูู).</div>
      </div>
      <a class="pill" href="./admin.html?v=999" target="_blank">ูุชุญ ุงูุฃุฏูู</a>
    </div>
  </div>

  <div class="card">
    <div class="muted">ุงุณูู:</div>
    <div id="playerName" class="big">โ</div>

    <div style="height:10px"></div>
    <div id="joinBox">
      <input id="nameInput" placeholder="ุงูุชุจ ุงุณูู" />
      <div style="height:10px"></div>
      <button type="button" id="joinBtn">ุชุณุฌูู</button>
    </div>

    <div style="height:10px"></div>
    <button type="button" id="clearBtn">ูุณุญ ุงูุงุณู</button>

    <div style="height:12px"></div>
    <div id="status" class="warn">ุจุงูุชุธุงุฑ ุงูุชุณุฌููโฆ</div>
    <div id="dbg" class="mono" style="margin-top:8px"></div>
    <div id="err" class="mono err" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div class="muted">ุญุงูุฉ ุงูุณุจุงู:</div>
    <div id="raceState" class="big">โ</div>
    <div style="height:10px"></div>
    <div class="muted">ุงูุณุคุงู ุงูุญุงูู:</div>
    <div id="questionText" class="big">ุจุงูุชุธุงุฑ ุจุฏุก ุงูุณุจุงูโฆ</div>
  </div>

  <div class="card">
    <div class="muted">ุขุฎุฑ 20 ุงุณู ูุณุฌู (ุชุฃููุฏ ุฃู ุงูุชุณุฌูู ุดุบุงู):</div>
    <ul id="playersList"></ul>
  </div>

</div>

<script type="module">
  // โ ููุณ firebaseConfig (ูุซุจูุช)
  const firebaseConfig = {
    apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
    authDomain: "jawad-race.firebaseapp.com",
    projectId: "jawad-race",
    storageBucket: "jawad-race.firebasestorage.app",
    messagingSenderId: "677185572718",
    appId: "1:677185572718:web:91c4674236efce1d6efb7f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp,
    query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const raceRef = doc(db, "race", "current");
  const questionsCol = collection(db, "questions");
  const playersCol = collection(db, "players");

  const playerNameEl = document.getElementById("playerName");
  const joinBox = document.getElementById("joinBox");
  const nameInput = document.getElementById("nameInput");
  const joinBtn = document.getElementById("joinBtn");
  const clearBtn = document.getElementById("clearBtn");
  const statusEl = document.getElementById("status");
  const dbgEl = document.getElementById("dbg");
  const errEl = document.getElementById("err");
  const raceStateEl = document.getElementById("raceState");
  const qEl = document.getElementById("questionText");
  const playersList = document.getElementById("playersList");

  const LS_NAME = "jr_player_name";
  const getName = () => localStorage.getItem(LS_NAME) || "";
  const setName = (v) => localStorage.setItem(LS_NAME, v);
  const clearName = () => localStorage.removeItem(LS_NAME);

  const say = (t, cls="warn") => { statusEl.className = cls; statusEl.textContent = t; };
  const setErr = (t="") => { errEl.textContent = t; };

  function renderName(){
    const n = getName();
    playerNameEl.textContent = n || "โ";
    joinBox.style.display = n ? "none" : "block";
  }
  renderName();

  clearBtn.onclick = () => { clearName(); renderName(); say("ุจุงูุชุธุงุฑ ุงูุชุณุฌููโฆ","warn"); };

  joinBtn.onclick = async () => {
    setErr("");
    const clean = (nameInput.value || "").trim();
    if (!clean) return setErr("ุงูุชุจ ุงูุงุณู ุฃูููุง");
    try{
      await addDoc(playersCol, { name: clean, createdAt: serverTimestamp() });
      setName(clean);
      renderName();
      say("ุชู ุงูุชุณุฌูู โ","ok");
    }catch(e){
      say("ูุดู ุงูุชุณุฌูู โ","err");
      setErr("ุงูุณุจุจ ุบุงูุจูุง: Firestore Rules. ุงูุชูุงุตูู: " + (e?.message || String(e)));
    }
  };

  // Race -> Question
  let unsubQ = null;
  const safeUnsub = (fn)=>{ try{ fn && fn(); }catch(_){} };

  onSnapshot(raceRef, (snap)=>{
    setErr("");
    if(!snap.exists()){
      raceStateEl.textContent = "race/current ุบูุฑ ููุฌูุฏ";
      qEl.textContent = "ุงุฐูุจ ููุฃุฏูู ูุงุถุบุท (ุชุตููุฑ ุงูุณุจุงู) ูุฑุฉ.";
      dbgEl.textContent = `projectId=${firebaseConfig.projectId}`;
      return;
    }

    const r = snap.data();
    raceStateEl.textContent = `status=${r.status||"-"} | index=${r.questionIndex ?? "-"}`;
    dbgEl.textContent = `projectId=${firebaseConfig.projectId} | activeQuestionId=${r.activeQuestionId ?? "null"}`;

    if (r.status === "waiting") say("ุจุงูุชุธุงุฑ ุจุฏุก ุงูุณุจุงู ูู ุงูููุธูโฆ","warn");
    if (r.status === "running") say("ุงูุณุจุงู ุดุบุงู โ","ok");
    if (r.status === "finished") say("ุงูุชูู ุงูุณุจุงู โ","ok");

    const qid = r.activeQuestionId || null;
    if(!qid){
      safeUnsub(unsubQ); unsubQ=null;
      qEl.textContent = "ุจุงูุชุธุงุฑ ุณุคุงูโฆ (ูู ุงูุฃุฏูู ุงุถุบุท: ุจุฏุก ุงูุณุจุงู ุซู ุงูุณุคุงู ุงูุชุงูู)";
      return;
    }

    safeUnsub(unsubQ);
    unsubQ = onSnapshot(doc(questionsCol, qid), (qs)=>{
      if(!qs.exists()){ qEl.textContent = "ุงูุณุคุงู ุบูุฑ ููุฌูุฏ ุฏุงุฎู questions"; return; }
      const q = qs.data();
      qEl.textContent = q.text || q.question || "ุณุคุงู ุจุฏูู ูุต";
    });

  }, (e)=>{
    say("ูุดู ูุฑุงุกุฉ ุงูุณุจุงู โ","err");
    setErr("ุงูุณุจุจ ุบุงูุจูุง: Firestore Rules. ุงูุชูุงุตูู: " + (e?.message || String(e)));
  });

  // ุขุฎุฑ 20 ุงุณู
  const pq = query(playersCol, orderBy("createdAt","desc"), limit(20));
  onSnapshot(pq, (snap)=>{
    playersList.innerHTML = "";
    snap.forEach(d=>{
      const li = document.createElement("li");
      li.textContent = d.data().name || "(ุจุฏูู ุงุณู)";
      playersList.appendChild(li);
    });
  }, (e)=>{
    setErr("ููุงุญุธุฉ: ูุง ุฃุณุชุทูุน ูุฑุงุกุฉ players (Rules). " + (e?.message || String(e)));
  });
</script>
</body>
</html>
