<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ุณุจุงู ุงูุฌูุงุฏ โ ุงููุชุณุงุจู</title>
  <style>
    body{font-family:system-ui,Segoe UI,Tahoma,Arial;background:#f6f7fb;margin:0;padding:18px}
    .wrap{max-width:860px;margin:auto}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.05);margin-bottom:12px}
    h1{margin:0 0 6px 0;font-size:24px}
    .sub{color:#666;margin-bottom:10px}
    input,button{width:100%;padding:12px;border-radius:12px;border:1px solid #d7dbe6;font-size:16px}
    button{cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .big{font-size:20px;font-weight:800}
    .muted{color:#666}
    .ok{color:#16a34a;font-weight:800}
    .warn{color:#b45309;font-weight:800}
    .err{color:#dc2626;font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;color:#444;white-space:pre-wrap}
    .opts{display:grid;gap:10px;margin-top:12px}
    .optBtn{background:#fff;text-align:right}
    .optBtn:hover{background:#f8fafc}
    .optChosen{border-color:#16a34a}
    .bar{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar > div{height:100%;background:#60a5fa;width:0%}
    .hide{display:none}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <h1>๐ ุณุจุงู ุงูุฌูุงุฏ โ ุงููุชุณุงุจู</h1>
        <div class="sub">ุณุฌูู ุงุณููุ ุซู ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุนูุฏ ุธููุฑ ุงูุฎูุงุฑุงุช.</div>
      </div>
      <a class="pill" href="./admin.html?v=999" target="_blank">ูุชุญ ุงูุฃุฏูู</a>
    </div>
  </div>

  <div class="card">
    <div class="muted">ุงุณูู:</div>
    <div id="playerName" class="big">โ</div>

    <div style="height:10px"></div>
    <div id="joinBox">
      <input id="nameInput" placeholder="ุงูุชุจ ุงุณูู" />
      <div style="height:10px"></div>
      <button type="button" id="joinBtn">ุชุณุฌูู</button>
    </div>

    <div style="height:10px"></div>
    <button type="button" id="clearBtn">ูุณุญ ุงูุงุณู</button>

    <div style="height:12px"></div>
    <div id="status" class="warn">ุจุงูุชุธุงุฑ ุงูุชุณุฌููโฆ</div>
    <div id="dbg" class="mono" style="margin-top:8px"></div>
    <div id="err" class="mono err" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div class="muted">ุญุงูุฉ ุงูุณุจุงู:</div>
    <div id="raceState" class="big">โ</div>

    <div style="height:10px"></div>
    <div class="muted">ุงูุณุคุงู ุงูุญุงูู:</div>
    <div id="questionText" class="big">ุจุงูุชุธุงุฑ ุจุฏุก ุงูุณุจุงูโฆ</div>

    <div class="opts" id="optionsBox"></div>

    <div id="answerNote" class="muted" style="margin-top:10px"></div>
  </div>

</div>

<script type="module">
  // โ ูุซุจุช ููุง ุฃุนุทูุชูู (ูุง ุชุนุฏู)
  const firebaseConfig = {
    apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
    authDomain: "jawad-race.firebaseapp.com",
    projectId: "jawad-race",
    storageBucket: "jawad-race.firebasestorage.app",
    messagingSenderId: "677185572718",
    appId: "1:677185572718:web:91c4674236efce1d6efb7f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp,
    query, where, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const raceRef     = doc(db, "race", "current");
  const questionsCol= collection(db, "questions");
  const answersCol  = collection(db, "answers");
  const playersCol  = collection(db, "players");

  // UI
  const playerNameEl = document.getElementById("playerName");
  const joinBox      = document.getElementById("joinBox");
  const nameInput    = document.getElementById("nameInput");
  const joinBtn      = document.getElementById("joinBtn");
  const clearBtn     = document.getElementById("clearBtn");
  const statusEl     = document.getElementById("status");
  const dbgEl        = document.getElementById("dbg");
  const errEl        = document.getElementById("err");
  const raceStateEl  = document.getElementById("raceState");
  const qEl          = document.getElementById("questionText");
  const optionsBox   = document.getElementById("optionsBox");
  const answerNote   = document.getElementById("answerNote");

  const LS_NAME = "jr_player_name";
  const getName = () => localStorage.getItem(LS_NAME) || "";
  const setName = (v) => localStorage.setItem(LS_NAME, v);
  const clearName = () => localStorage.removeItem(LS_NAME);

  const say = (t, cls="warn") => { statusEl.className = cls; statusEl.textContent = t; };
  const setErr = (t="") => { errEl.textContent = t; };

  function renderName(){
    const n = getName();
    playerNameEl.textContent = n || "โ";
    joinBox.style.display = n ? "none" : "block";
  }
  renderName();

  clearBtn.onclick = () => { clearName(); renderName(); say("ุจุงูุชุธุงุฑ ุงูุชุณุฌููโฆ","warn"); };

  joinBtn.onclick = async () => {
    setErr("");
    const clean = (nameInput.value || "").trim();
    if (!clean) return setErr("ุงูุชุจ ุงูุงุณู ุฃูููุง");
    try{
      await addDoc(playersCol, { name: clean, createdAt: serverTimestamp() });
      setName(clean);
      renderName();
      say("ุชู ุงูุชุณุฌูู โ","ok");
    }catch(e){
      say("ูุดู ุงูุชุณุฌูู โ","err");
      setErr("ุงูุณุจุจ ุบุงูุจูุง: Firestore Rules. ุงูุชูุงุตูู: " + (e?.message || String(e)));
    }
  };

  // ==== ุงุณุชุฎุฑุงุฌ ุงูุฎูุงุฑุงุช ูู ุฃู ุดูู ุดุงุฆุน ====
  function extractOptions(q){
    if(!q) return [];
    // 1) array ูุจุงุดุฑ
    const directArrays = ["options","choices","answers","items","variants"];
    for (const k of directArrays){
      if (Array.isArray(q[k]) && q[k].filter(Boolean).length){
        return q[k].map(String);
      }
    }
    // 2) object choices {A:"",B:""}
    if (q.choices && typeof q.choices === "object" && !Array.isArray(q.choices)){
      const vals = Object.values(q.choices).filter(Boolean).map(String);
      if (vals.length) return vals;
    }
    // 3) option1..4
    const optN = ["option1","option2","option3","option4","option5","option6"];
    const valsN = optN.map(k=>q[k]).filter(Boolean).map(String);
    if (valsN.length) return valsN;

    // 4) a,b,c,d or A,B,C,D
    const abcd = ["a","b","c","d","A","B","C","D"];
    const valsABCD = abcd.map(k=>q[k]).filter(Boolean).map(String);
    if (valsABCD.length) return valsABCD;

    // 5) text1..4
    const txtN = ["text1","text2","text3","text4"];
    const valsTxt = txtN.map(k=>q[k]).filter(Boolean).map(String);
    if (valsTxt.length) return valsTxt;

    return [];
  }

  // === ุญุงูุฉ ุงูุฅุฌุงุจุฉ ===
  let currentQid = null;
  let answeredKey = null; // "qid|name"
  function makeAnsweredKey(qid){
    return `${qid}||${getName()}`;
  }

  async function hasAnswered(qid){
    const name = getName();
    if(!name) return false;
    // ูุจุญุซ ุฅู ูุงู ุงููุงุนุจ ุฃุฌุงุจ ุนูู ุงูุณุคุงู
    const qy = query(answersCol, where("questionId","==", qid), where("playerName","==", name), limit(1));
    const snap = await getDocs(qy);
    return !snap.empty;
  }

  async function submitAnswer(qid, optionText, optionIndex){
    const name = getName();
    if(!name) { setErr("ุณุฌูู ุงุณูู ุฃูููุง"); return; }
    await addDoc(answersCol, {
      questionId: qid,
      playerName: name,
      optionText,
      optionIndex,
      createdAt: serverTimestamp(),
    });
  }

  function clearOptionsUI(){
    optionsBox.innerHTML = "";
    answerNote.textContent = "";
  }

  function renderOptions(qid, options){
    clearOptionsUI();
    if(!options.length){
      answerNote.innerHTML = "โ๏ธ <b>ูุง ูููุช ุฎูุงุฑุงุช ููุฐุง ุงูุณุคุงู</b> ุฏุงุฎู Firestore. ูุงุฒู ุชุถูู ุฎูุงุฑุงุช ูู ูุซููุฉ ุงูุณุคุงู (options ุฃู choices ุฃู option1..4).";
      return;
    }

    const key = makeAnsweredKey(qid);
    answeredKey = key;

    options.forEach((txt, idx)=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "optBtn";
      btn.textContent = `(${idx+1}) ${txt}`;
      btn.onclick = async () => {
        setErr("");
        try{
          // ููุน ุชูุฑุงุฑ ุงูุฅุฌุงุจุฉ
          btn.disabled = true;
          await submitAnswer(qid, txt, idx);
          answerNote.innerHTML = "โ ุชู ุชุณุฌูู ุฅุฌุงุจุชู.";
          // ุงููู ุฌููุน ุงูุฃุฒุฑุงุฑ
          [...optionsBox.querySelectorAll("button")].forEach(b=>b.disabled=true);
          btn.classList.add("optChosen");
        }catch(e){
          setErr("ูุดู ุชุณุฌูู ุงูุฅุฌุงุจุฉ: " + (e?.message || String(e)));
          btn.disabled = false;
        }
      };
      optionsBox.appendChild(btn);
    });
  }

  // ==== ูุชุงุจุนุฉ ุงูุณุจุงู + ุงูุณุคุงู ====
  let unsubQ = null;
  const safeUnsub = (fn)=>{ try{ fn && fn(); }catch(_){} };

  onSnapshot(raceRef, async (snap)=>{
    setErr("");
    if(!snap.exists()){
      raceStateEl.textContent = "race/current ุบูุฑ ููุฌูุฏ";
      qEl.textContent = "ุงุฐูุจ ููุฃุฏูู ูุงุถุบุท (ุชุตููุฑ ุงูุณุจุงู) ูุฑุฉ.";
      dbgEl.textContent = `projectId=${firebaseConfig.projectId}`;
      clearOptionsUI();
      return;
    }

    const r = snap.data();
    raceStateEl.textContent = `status=${r.status||"-"} | index=${r.questionIndex ?? "-"}`;
    dbgEl.textContent = `projectId=${firebaseConfig.projectId} | activeQuestionId=${r.activeQuestionId ?? "null"}`;

    if (r.status === "waiting") say("ุจุงูุชุธุงุฑ ุจุฏุก ุงูุณุจุงู ูู ุงูููุธูโฆ","warn");
    if (r.status === "running") say("ุงูุณุจุงู ุดุบุงู โ","ok");
    if (r.status === "finished") say("ุงูุชูู ุงูุณุจุงู โ","ok");

    const qid = r.activeQuestionId || null;
    if(!qid){
      safeUnsub(unsubQ); unsubQ=null;
      qEl.textContent = "ุจุงูุชุธุงุฑ ุณุคุงูโฆ (ูู ุงูุฃุฏูู ุงุถุบุท: ุจุฏุก ุงูุณุจุงู ุซู ุงูุณุคุงู ุงูุชุงูู)";
      clearOptionsUI();
      currentQid = null;
      return;
    }

    // ุณุคุงู ุฌุฏูุฏุ
    if (currentQid !== qid){
      currentQid = qid;
      clearOptionsUI();
    }

    safeUnsub(unsubQ);
    unsubQ = onSnapshot(doc(questionsCol, qid), async (qs)=>{
      if(!qs.exists()){
        qEl.textContent = "ุงูุณุคุงู ุบูุฑ ููุฌูุฏ ุฏุงุฎู questions";
        clearOptionsUI();
        return;
      }
      const q = qs.data();
      qEl.textContent = q.text || q.question || q.title || "ุณุคุงู ุจุฏูู ูุต";

      const options = extractOptions(q);
      renderOptions(qid, options);

      // ุฅุฐุง ุงููุงุนุจ ุฃุฌุงุจ ุณุงุจููุงุ ุงููู ุงูุฎูุงุฑุงุช ูุนุฑูู ุงููุณุชุฎุฏู
      try{
        const done = await hasAnswered(qid);
        if(done){
          answerNote.innerHTML = "โ ุฃูุช ุฌุงูุจุช ูุฐุง ุงูุณุคุงู ูุณุจููุง.";
          [...optionsBox.querySelectorAll("button")].forEach(b=>b.disabled=true);
        }
      }catch(_){}
    });

  }, (e)=>{
    say("ูุดู ูุฑุงุกุฉ ุงูุณุจุงู โ","err");
    setErr("ุงูุณุจุจ ุบุงูุจูุง: Rules. ุงูุชูุงุตูู: " + (e?.message || String(e)));
  });

</script>
</body>
</html>
