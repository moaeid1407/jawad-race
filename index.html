<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</title>

  <style>
    :root{
      --bg:#071c1b;
      --panel:#0e2a28;
      --accent:#f59e0b;
      --green:#22c55e;
      --text:#ffffff;
      --muted:rgba(255,255,255,.7);
      --dash:rgba(34,197,94,.55);
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: 30px 14px;
    }
    .wrap{ width: min(860px, 100%); text-align:center; }
    h1{ margin: 12px 0 6px; font-size: clamp(28px, 4vw, 44px); }
    .sub{ margin:0 0 18px; color: var(--muted); font-size: 16px; }

    .waiting{
      border: 2px dashed var(--dash);
      border-radius: 18px;
      padding: 18px 16px;
      margin: 16px auto 18px;
      background: rgba(14,42,40,.35);
      color: var(--green);
      font-size: clamp(18px, 2.3vw, 24px);
      line-height:1.7;
      width: min(740px, 100%);
    }
    .card{
      width:min(740px, 100%);
      margin: 0 auto;
      background: rgba(14,42,40,.55);
      border-radius: 22px;
      padding: 18px 16px 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }

    input, textarea, select{
      width: min(640px, 100%);
      padding: 12px 14px;
      border-radius: 14px;
      border: 0;
      outline: none;
      font-size: 16px;
      text-align:right;
      margin-top: 8px;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .hint{ margin: 10px 0 14px; color: var(--muted); font-size: 14px; }

    .btns{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    button{
      border:0;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 16px;
      cursor:pointer;
      background: var(--accent);
      color:#111;
      font-weight:700;
      min-width: 150px;
    }
    button.secondary{
      background: rgba(255,255,255,.12);
      color: #fff;
      border: 1px solid rgba(255,255,255,.18);
      font-weight:600;
    }
    button.danger{
      background: var(--danger);
      color:#fff;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .timer{
      font-size: clamp(52px, 8vw, 78px);
      margin: 14px 0 8px;
      font-weight: 800;
      letter-spacing: 1px;
    }

    .footer{
      margin-top: 10px;
      color: rgba(255,255,255,.65);
      font-size: 13px;
    }

    /* Admin */
    .adminBox{
      margin-top: 18px;
      text-align:right;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 14px;
    }
    .adminTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .adminTitle h3{ margin:0; font-size: 18px; }
    .pill{
      padding:6px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(34,197,94,.15);
      color: var(--green);
      border: 1px solid rgba(34,197,94,.35);
      white-space:nowrap;
    }
    .list{
      max-height: 260px;
      overflow:auto;
      padding: 10px;
      background: rgba(255,255,255,.06);
      border-radius: 12px;
      text-align:right;
    }
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 8px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 14px;
    }
    .row:last-child{ border-bottom:0; }
    .muted{ color: rgba(255,255,255,.7); }
    .small{
      font-size:12px;
      color: rgba(255,255,255,.65);
      margin-top: 8px;
      text-align:right;
      line-height:1.7;
    }

    /* Question UI */
    .qBox{
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      text-align:right;
    }
    .qTitle{
      font-size: 18px;
      font-weight: 800;
      margin: 0 0 10px;
      line-height:1.7;
    }
    .options{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .opt{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
    }
    .opt input{ width:auto; margin:0; }
    .opt span{ line-height:1.6; }
    .statusOk{ color: var(--green); font-weight:800; margin-top:10px; }
    .statusWarn{ color: #fbbf24; font-weight:800; margin-top:10px; }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</h1>
    <p class="sub">Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© â€” Ø¥Ø´Ø±Ø§Ù Ù„Ø¬Ù†Ø© Ù…Ù†Ø§Ø¨Ø± Ø§Ù„Ù†ÙˆØ± Ø¨Ø§Ù„Ø¬ÙØ±</p>

    <div id="waitingMessage" class="waiting">
      â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…<br/>
      ğŸš¦ Ø§Ø³ØªØ¹Ø¯ÙˆØ§
    </div>

    <div class="card">
      <!-- PLAYER UI -->
      <div id="playerUI">
        <input id="playerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙÙ‚Ø·" autocomplete="off" />
        <div class="hint">Ø§Ø¶ØºØ· <b>ØªØ³Ø¬ÙŠÙ„</b> Ø¨Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…</div>

        <div class="btns">
          <button id="joinBtn">ØªØ³Ø¬ÙŠÙ„</button>
        </div>

        <div class="timer" id="timer">00:00</div>

        <!-- Question box for player -->
        <div id="playerQuestionBox" class="qBox" style="display:none;">
          <div class="qTitle" id="qText"></div>
          <div class="options" id="qOptions"></div>
          <div class="btns" style="justify-content:flex-start;">
            <button id="submitAnswerBtn" class="secondary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
          </div>
          <div id="answerStatus" class="statusWarn" style="display:none;"></div>
        </div>
      </div>

      <!-- ADMIN UI -->
      <div id="adminUI" style="display:none;">
        <div class="btns">
          <button id="adminStartBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
          <button class="secondary" id="adminStopBtn">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù / Ù…ØªØ§Ø¨Ø¹Ø©</button>
          <button class="danger" id="adminResetBtn">â™»ï¸ ØªØµÙÙŠØ±</button>
        </div>

        <div class="timer" id="adminTimer">00:00</div>

        <div class="adminBox">
          <div class="adminTitle">
            <h3>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙˆÙ†</h3>
            <div class="pill" id="countPill">0 Ù…ØªØ³Ø§Ø¨Ù‚</div>
          </div>
          <div class="list" id="playersList"></div>
          <div class="small">
            âœ… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªÙØ³Ø­Ø¨ Ù„Ø§ÙŠÙ Ù…Ù† Firestore.
          </div>
        </div>

        <div class="adminBox">
          <div class="adminTitle">
            <h3>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
            <div class="pill" id="qCountPill">0 Ø³Ø¤Ø§Ù„</div>
          </div>

          <div class="small">
            Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„ + 4 Ø®ÙŠØ§Ø±Ø§Øª + Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø«Ù… <b>Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</b> â†’ Ø¨Ø¹Ø¯Ù‡Ø§ Ø§Ø®ØªØ±Ù‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ø¶ØºØ· <b>Ù†Ø´Ø± Ø§Ù„Ø³Ø¤Ø§Ù„</b>.
          </div>

          <textarea id="newQText" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..."></textarea>

          <input id="optA" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± A" />
          <input id="optB" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± B" />
          <input id="optC" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± C" />
          <input id="optD" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± D" />

          <select id="correctOpt">
            <option value="0">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: A</option>
            <option value="1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: B</option>
            <option value="2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: C</option>
            <option value="3">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: D</option>
          </select>

          <div class="btns" style="justify-content:flex-start;">
            <button id="saveQuestionBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
            <button id="clearQuestionBtn" class="secondary">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          </div>

          <div style="height:12px;"></div>

          <div class="small"><b>Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¤Ø§Ù„ Ù„Ù„Ù†Ø´Ø±:</b></div>
          <select id="questionPicker" style="text-align:right;"></select>

          <div class="btns" style="justify-content:flex-start;">
            <button id="publishQuestionBtn">ğŸ“£ Ù†Ø´Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</button>
            <button id="clearPublishedBtn" class="secondary">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
          </div>

          <div class="small">
            âœ… Ø¹Ù†Ø¯ Ù†Ø´Ø± Ø§Ù„Ø³Ø¤Ø§Ù„: ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ù‹Ø§ Ù„ÙƒÙ„ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø­ØªÙ‰ Ù„Ùˆ Ø¬ÙˆØ§Ù„Ø§ØªÙ‡Ù… Ù…ÙØªÙˆØ­Ø©.
          </div>
        </div>

        <div class="adminBox">
          <div class="adminTitle">
            <h3>Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <div class="pill" id="ansCountPill">0 Ø¥Ø¬Ø§Ø¨Ø©</div>
          </div>
          <div class="list" id="answersList"></div>
          <div class="small">
            âœ… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙÙŠ: <b>races/current/answers</b>
          </div>
        </div>
      </div>

      <div class="footer">Â«Ø§Ù„Ù„Ù‡Ù… Ø§Ø±Ø²Ù‚Ù†Ø§ ØªÙˆÙÙŠÙ‚ Ø§Ù„Ø·Ø§Ø¹Ø©ØŒ ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹ØµÙŠØ©ØŒ ÙˆØµØ¯Ù‚ Ø§Ù„Ù†ÙŠØ©Â» â€” Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)</div>
    </div>
  </div>

<script>
/* =========================
   Firebase Config (Ø¬Ø§Ù‡Ø²)
   ========================= */
firebase.initializeApp({
  apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
  authDomain: "jawad-race.firebaseapp.com",
  projectId: "jawad-race",
  storageBucket: "jawad-race.firebasestorage.app",
  messagingSenderId: "677185572718",
  appId: "1:677185572718:web:91c4674236efce1d6efb7f"
});

const db = firebase.firestore();

/* =========================
   Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¨Ø§Ù‚
   ========================= */
const RACE_ID = "current";
const raceRef = db.collection("races").doc(RACE_ID);
const playersRef = db.collection("players");
const questionsRef = db.collection("questions"); // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
const answersRef = raceRef.collection("answers"); // Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ

const qs = new URLSearchParams(location.search);
const isAdmin = qs.get("admin") === "1";

/* =========================
   Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
   ========================= */
const waitingMessage = document.getElementById("waitingMessage");

const playerUI = document.getElementById("playerUI");
const adminUI  = document.getElementById("adminUI");

const playerName = document.getElementById("playerName");
const joinBtn = document.getElementById("joinBtn");
const timerEl = document.getElementById("timer");

const adminStartBtn = document.getElementById("adminStartBtn");
const adminStopBtn  = document.getElementById("adminStopBtn");
const adminResetBtn = document.getElementById("adminResetBtn");
const adminTimerEl = document.getElementById("adminTimer");

const playersList = document.getElementById("playersList");
const countPill = document.getElementById("countPill");

const playerQuestionBox = document.getElementById("playerQuestionBox");
const qText = document.getElementById("qText");
const qOptions = document.getElementById("qOptions");
const submitAnswerBtn = document.getElementById("submitAnswerBtn");
const answerStatus = document.getElementById("answerStatus");

const newQText = document.getElementById("newQText");
const optA = document.getElementById("optA");
const optB = document.getElementById("optB");
const optC = document.getElementById("optC");
const optD = document.getElementById("optD");
const correctOpt = document.getElementById("correctOpt");
const saveQuestionBtn = document.getElementById("saveQuestionBtn");
const clearQuestionBtn = document.getElementById("clearQuestionBtn");
const questionPicker = document.getElementById("questionPicker");
const publishQuestionBtn = document.getElementById("publishQuestionBtn");
const clearPublishedBtn = document.getElementById("clearPublishedBtn");
const qCountPill = document.getElementById("qCountPill");

const answersList = document.getElementById("answersList");
const ansCountPill = document.getElementById("ansCountPill");

/* =========================
   ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Admin/Player)
   ========================= */
if(isAdmin){
  playerUI.style.display = "none";
  adminUI.style.display  = "block";
} else {
  playerUI.style.display = "block";
  adminUI.style.display  = "none";
}

/* =========================
   Ù…Ø¤Ù‚Øª Ù…Ø­Ù„ÙŠ
   ========================= */
let tickInterval = null;

function fmt(ms){
  const total = Math.max(0, Math.floor(ms/1000));
  const m = String(Math.floor(total/60)).padStart(2,"0");
  const s = String(total%60).padStart(2,"0");
  return `${m}:${s}`;
}

function stopTick(){
  if(tickInterval){ clearInterval(tickInterval); tickInterval = null; }
}

function startTick(startAtMs, paused){
  stopTick();
  const update = () => {
    if(paused) return;
    const now = Date.now();
    const diff = now - startAtMs;
    const t = fmt(diff);
    timerEl.textContent = t;
    adminTimerEl.textContent = t;
  };
  update();
  tickInterval = setInterval(update, 250);
}

/* =========================
   Ø­ÙØ¸ Ù‡ÙˆÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹
   ========================= */
function getLocalPlayer(){
  return {
    name: localStorage.getItem("jr_playerName") || "",
    id: localStorage.getItem("jr_playerId") || ""
  };
}
function setLocalPlayer(name, id){
  localStorage.setItem("jr_playerName", name);
  localStorage.setItem("jr_playerId", id);
}
(function restorePlayer(){
  const p = getLocalPlayer();
  if(!isAdmin && p.name){
    playerName.value = p.name;
    playerName.disabled = true;
    joinBtn.disabled = true;
  }
})();

/* =========================
   ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚
   ========================= */
async function joinRace(){
  const name = (playerName.value || "").trim();
  if(name.length < 5){
    alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
    return;
  }

  joinBtn.disabled = true;

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù„Ù†ÙØ³ Ø§Ù„Ø³Ø¨Ø§Ù‚
  const exists = await playersRef
    .where("raceId","==",RACE_ID)
    .where("name","==",name)
    .limit(1)
    .get();

  if(!exists.empty){
    // Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„ ÙˆØ«ÙŠÙ‚Ø© ÙƒÙ€ playerId
    const first = exists.docs[0];
    setLocalPlayer(name, first.id);
    alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…");
    playerName.disabled = true;
    joinBtn.disabled = true;
    return;
  }

  const docRef = await playersRef.add({
    name,
    raceId: RACE_ID,
    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  setLocalPlayer(name, docRef.id);

  alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ… Ø§Ù†ØªØ¸Ø± Ù†Ø´Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©/Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…");
  joinBtn.disabled = true;
  playerName.disabled = true;
}

joinBtn?.addEventListener("click", joinRace);
playerName?.addEventListener("keypress", (e)=>{ if(e.key==="Enter") joinRace(); });

/* =========================
   Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ­ÙƒÙ…: Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù„Ø§ÙŠÙ
   ========================= */
if(isAdmin){
  playersRef
    .where("raceId","==",RACE_ID)
    .orderBy("joinedAt","asc")
    .onSnapshot((snap)=>{
      const arr = [];
      snap.forEach(doc => arr.push({id: doc.id, ...doc.data()}));
      countPill.textContent = `${arr.length} Ù…ØªØ³Ø§Ø¨Ù‚`;

      playersList.innerHTML = arr.length ? "" : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯â€¦</div>`;
      arr.forEach((p, idx)=>{
        const joined = p.joinedAt?.toDate ? p.joinedAt.toDate() : null;
        const time = joined ? joined.toLocaleTimeString("ar-SA") : "--:--";
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `<div>${idx+1}) ${p.name}</div><div class="muted">${time}</div>`;
        playersList.appendChild(div);
      });
    });
}

/* =========================
   Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Admin)
   ========================= */
function clearQuestionForm(){
  newQText.value = "";
  optA.value = "";
  optB.value = "";
  optC.value = "";
  optD.value = "";
  correctOpt.value = "0";
}

if(isAdmin){
  clearQuestionBtn.addEventListener("click", clearQuestionForm);

  saveQuestionBtn.addEventListener("click", async ()=>{
    const text = (newQText.value || "").trim();
    const a = (optA.value || "").trim();
    const b = (optB.value || "").trim();
    const c = (optC.value || "").trim();
    const d = (optD.value || "").trim();
    const correctIndex = Number(correctOpt.value);

    if(!text || !a || !b || !c || !d){
      alert("Ø§ÙƒÙ…Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ + Ø§Ù„Ø£Ø±Ø¨Ø¹ Ø®ÙŠØ§Ø±Ø§Øª");
      return;
    }

    await questionsRef.add({
      text,
      options: [a,b,c,d],
      correctIndex, // 0..3
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ âœ…");
    clearQuestionForm();
  });

  // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
  questionsRef.orderBy("createdAt","asc").onSnapshot((snap)=>{
    const qsArr = [];
    snap.forEach(d => qsArr.push({ id: d.id, ...d.data() }));

    qCountPill.textContent = `${qsArr.length} Ø³Ø¤Ø§Ù„`;

    // ØªØ¹Ø¨Ø¦Ø© select
    questionPicker.innerHTML = "";
    if(qsArr.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯";
      questionPicker.appendChild(opt);
      return;
    }

    qsArr.forEach((q, i)=>{
      const opt = document.createElement("option");
      opt.value = q.id;
      const short = (q.text || "").slice(0, 40);
      opt.textContent = `${i+1}) ${short}${q.text.length>40 ? "..." : ""}`;
      questionPicker.appendChild(opt);
    });
  });

  publishQuestionBtn.addEventListener("click", async ()=>{
    const qId = questionPicker.value;
    if(!qId){
      alert("Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„ Ø£ÙˆÙ„Ø§Ù‹");
      return;
    }

    // Ù†Ø´Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ + ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    const batch = db.batch();

    batch.set(raceRef, {
      activeQuestionId: qId,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // Ø­Ø°Ù Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)
    const old = await answersRef.get();
    old.forEach(doc => batch.delete(doc.ref));

    await batch.commit();
    alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† âœ…");
  });

  clearPublishedBtn.addEventListener("click", async ()=>{
    await raceRef.set({
      activeQuestionId: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // Ø­Ø°Ù Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const batch = db.batch();
    const old = await answersRef.get();
    old.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    alert("ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„ âœ…");
  });
}

/* =========================
   Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚: Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ + Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
   ========================= */
let currentActiveQuestionId = null;
let selectedAnswerIndex = null;

function renderQuestion(q){
  qText.textContent = q.text || "";
  qOptions.innerHTML = "";
  selectedAnswerIndex = null;

  (q.options || []).forEach((txt, idx)=>{
    const label = document.createElement("label");
    label.className = "opt";
    label.innerHTML = `
      <input type="radio" name="ans" value="${idx}">
      <span>${txt}</span>
    `;
    label.addEventListener("click", ()=>{
      selectedAnswerIndex = idx;
      // ØªØ£ÙƒÙŠØ¯ radio
      const radio = label.querySelector("input");
      if(radio) radio.checked = true;
    });
    qOptions.appendChild(label);
  });

  answerStatus.style.display = "none";
  playerQuestionBox.style.display = "block";
}

async function submitAnswer(){
  const p = getLocalPlayer();
  if(!p.name){
    alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }
  if(!currentActiveQuestionId){
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø¢Ù†");
    return;
  }
  if(selectedAnswerIndex === null){
    alert("Ø§Ø®ØªØ± Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  submitAnswerBtn.disabled = true;

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: Ù…ÙØªØ§Ø­ = playerId (Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ù„Ùˆ Ù…Ø§ ØªÙˆÙØ±)
  const answerDocId = p.id || p.name;
  await answersRef.doc(answerDocId).set({
    playerId: p.id || null,
    playerName: p.name,
    questionId: currentActiveQuestionId,
    answerIndex: selectedAnswerIndex,
    answeredAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  answerStatus.textContent = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨ØªÙƒ âœ…";
  answerStatus.className = "statusOk";
  answerStatus.style.display = "block";
  submitAnswerBtn.disabled = false;
}

submitAnswerBtn?.addEventListener("click", submitAnswer);

/* =========================
   Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¨Ø§Ù‚ + Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± (ØªØµÙ„ Ù„Ù„Ø¬Ù…ÙŠØ¹)
   races/current:
   {
     status: "waiting|running",
     startAt: timestamp|null,
     paused: bool,
     activeQuestionId: string|null
   }
   ========================= */
raceRef.onSnapshot(async (doc)=>{
  if(!doc.exists){
    await raceRef.set({
      status: "waiting",
      paused: false,
      startAt: null,
      activeQuestionId: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return;
  }

  const data = doc.data() || {};
  const status = data.status || "waiting";
  const paused = !!data.paused;

  // Ù…Ø¤Ù‚Øª
  if(status === "waiting"){
    waitingMessage.style.display = "block";
    stopTick();
    timerEl.textContent = "00:00";
    adminTimerEl.textContent = "00:00";
  } else if(status === "running"){
    waitingMessage.style.display = "none";
    const startAt = data.startAt?.toDate ? data.startAt.toDate().getTime() : Date.now();
    startTick(startAt, paused);
  }

  // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const activeQ = data.activeQuestionId || null;
  currentActiveQuestionId = activeQ;

  if(!isAdmin){
    if(!activeQ){
      // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ Ù…Ù†Ø´ÙˆØ±
      playerQuestionBox.style.display = "none";
      return;
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ¹Ø±Ø¶Ù‡
    const qDoc = await questionsRef.doc(activeQ).get();
    if(!qDoc.exists){
      playerQuestionBox.style.display = "none";
      return;
    }
    renderQuestion(qDoc.data());
  }
});

/* =========================
   Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ­ÙƒÙ… (Ø§Ù„Ø³Ø¨Ø§Ù‚)
   ========================= */
async function adminStart(){
  await raceRef.set({
    status: "running",
    paused: false,
    startAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminTogglePause(){
  const doc = await raceRef.get();
  const paused = !!doc.data()?.paused;
  await raceRef.set({
    paused: !paused,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminReset(){
  // ÙŠØ±Ø¬Ø¹ Waiting ÙˆÙŠØµÙØ± Ø§Ù„ØªØ§ÙŠÙ…Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹ + ÙŠØ®ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ + ÙŠÙ…Ø³Ø­ Ø¥Ø¬Ø§Ø¨Ø§Øª
  const batch = db.batch();
  batch.set(raceRef, {
    status: "waiting",
    paused: false,
    startAt: null,
    activeQuestionId: null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  const old = await answersRef.get();
  old.forEach(doc => batch.delete(doc.ref));

  await batch.commit();
}

if(isAdmin){
  adminStartBtn.addEventListener("click", adminStart);
  adminStopBtn.addEventListener("click", adminTogglePause);
  adminResetBtn.addEventListener("click", adminReset);
}

/* =========================
   Admin: Ø¹Ø±Ø¶ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø§ÙŠÙ
   ========================= */
if(isAdmin){
  answersRef.orderBy("answeredAt","asc").onSnapshot((snap)=>{
    const arr = [];
    snap.forEach(doc => arr.push({id: doc.id, ...doc.data()}));

    ansCountPill.textContent = `${arr.length} Ø¥Ø¬Ø§Ø¨Ø©`;

    answersList.innerHTML = arr.length ? "" : `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ø¹Ø¯â€¦</div>`;
    arr.forEach((a, idx)=>{
      const t = a.answeredAt?.toDate ? a.answeredAt.toDate().toLocaleTimeString("ar-SA") : "--:--";
      const ansLetter = ["A","B","C","D"][a.answerIndex] ?? "-";
      const div = document.createElement("div");
      div.className = "row";
      div.innerHTML = `<div>${idx+1}) ${a.playerName} â€” <b>${ansLetter}</b></div><div class="muted">${t}</div>`;
      answersList.appendChild(div);
    });
  });
}
</script>

</body>
</html>
