<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</title>

  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#0b1e1b;
      color:#fff;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .wrap{
      width:min(900px,95vw);
      margin:30px auto;
      text-align:center;
    }
    h1{margin:10px 0;}
    .sub{color:#ccc;margin-bottom:15px;}

    .card{
      background:#0f2a26;
      border-radius:16px;
      padding:20px;
    }

    input{
      width:min(400px,90%);
      padding:14px;
      border-radius:10px;
      border:none;
      font-size:18px;
    }

    button{
      padding:12px 20px;
      border-radius:10px;
      border:none;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      margin:6px;
      background:#f6a000;
    }

    .secondary{background:#333;color:#fff;}
    .danger{background:#b00020;color:#fff;}

    .waiting{
      border:2px dashed #26c281;
      padding:15px;
      border-radius:12px;
      margin-bottom:15px;
      font-size:20px;
      color:#b8ffd9;
    }

    .timer{
      font-size:64px;
      margin-top:15px;
    }

    .hidden{display:none;}

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:15px;
    }

    .box{
      border:1px solid #444;
      border-radius:10px;
      padding:10px;
      text-align:right;
      min-height:120px;
    }

    @media(max-width:700px){
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</h1>
  <div class="sub">Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© â€“ Ù„Ø¬Ù†Ø© Ù…Ù†Ø§Ø¨Ø± Ø§Ù„Ù†ÙˆØ± Ø¨Ø§Ù„Ø¬ÙØ±</div>

  <div class="card">
    <div class="waiting" id="waitingMsg">
      â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…<br>ğŸš¦ Ø§Ø³ØªØ¹Ø¯ÙˆØ§
    </div>

    <!-- Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ -->
    <div id="playerUI">
      <input id="playerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
      <div>
        <button class="secondary" id="joinBtn">ØªØ³Ø¬ÙŠÙ„</button>
      </div>
    </div>

    <!-- Ø§Ù„Ù…ØªØ­ÙƒÙ… -->
    <div id="adminUI" class="hidden">
      <input id="adminPin" placeholder="PIN Ø§Ù„Ù…ØªØ­ÙƒÙ…" style="width:200px">
      <div>
        <button id="unlockBtn">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­ÙƒÙ…</button>
        <button id="startBtn" disabled>â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
        <button class="danger" id="resetBtn" disabled>Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      </div>

      <div class="grid">
        <div class="box">
          <b>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙˆÙ†</b>
          <pre id="playersList">â€”</pre>
        </div>
        <div class="box">
          <b>Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¨Ø§Ù‚</b>
          <pre id="raceState">â€”</pre>
        </div>
      </div>
    </div>

    <div class="timer" id="timer">00:00</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  doc, setDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ğŸ”´ Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù‡Ù†Ø§ */
const firebaseConfig = {
  apiKey: "PUT_YOURS_HERE",
  authDomain: "PUT_YOURS_HERE",
  projectId: "PUT_YOURS_HERE",
  storageBucket: "PUT_YOURS_HERE",
  messagingSenderId: "PUT_YOURS_HERE",
  appId: "PUT_YOURS_HERE",
};

const ADMIN_PIN = "2580";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(location.search);
const isAdmin = params.get("admin") === "1";

const playersCol = collection(db,"players");
const raceRef = doc(db,"race","main");

const waitingMsg = document.getElementById("waitingMsg");
const timerEl = document.getElementById("timer");

let timerInt=null;

function startTimer(start){
  clearInterval(timerInt);
  timerInt=setInterval(()=>{
    const diff=Date.now()-start;
    const s=Math.floor(diff/1000);
    timerEl.textContent=
      String(Math.floor(s/60)).padStart(2,"0")+":"+
      String(s%60).padStart(2,"0");
  },300);
}

onSnapshot(raceRef,snap=>{
  if(!snap.exists()) return;
  const d=snap.data();
  document.getElementById("raceState").textContent=JSON.stringify(d,null,2);
  if(d.started){
    waitingMsg.classList.add("hidden");
    startTimer(d.startTime);
  }else{
    waitingMsg.classList.remove("hidden");
    timerEl.textContent="00:00";
  }
});

if(isAdmin){
  document.getElementById("playerUI").classList.add("hidden");
  document.getElementById("adminUI").classList.remove("hidden");

  onSnapshot(playersCol,snap=>{
    let t="";
    let i=1;
    snap.forEach(d=>{
      t+=`${i++}) ${d.data().name}\n`;
    });
    document.getElementById("playersList").textContent=t||"â€”";
  });

  document.getElementById("unlockBtn").onclick=()=>{
    if(document.getElementById("adminPin").value===ADMIN_PIN){
      document.getElementById("startBtn").disabled=false;
      document.getElementById("resetBtn").disabled=false;
      alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­ÙƒÙ…");
    }else alert("PIN Ø®Ø·Ø£");
  };

  document.getElementById("startBtn").onclick=()=>{
    updateDoc(raceRef,{started:true,startTime:Date.now()});
  };
  document.getElementById("resetBtn").onclick=()=>{
    updateDoc(raceRef,{started:false,startTime:0});
  };

}else{
  document.getElementById("joinBtn").onclick=async()=>{
    const name=document.getElementById("playerName").value.trim();
    if(name.length<2) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… ØµØ­ÙŠØ­");
    await addDoc(playersCol,{name,joinedAt:Date.now()});
    alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø§Ù†ØªØ¸Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚");
  };
}
</script>
</body>
</html>
