<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</title>

  <style>
    :root{
      --bg:#071c1b;
      --panel:#0e2a28;
      --accent:#f59e0b;
      --green:#22c55e;
      --text:#ffffff;
      --muted:rgba(255,255,255,.7);
      --dash:rgba(34,197,94,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: 30px 14px;
    }
    .wrap{ width: min(760px, 100%); text-align:center; }
    h1{ margin: 12px 0 6px; font-size: clamp(28px, 4vw, 44px); letter-spacing:.3px; }
    .sub{ margin:0 0 18px; color: var(--muted); font-size: 16px; }

    .waiting{
      border: 2px dashed var(--dash);
      border-radius: 18px;
      padding: 18px 16px;
      margin: 16px auto 18px;
      background: rgba(14,42,40,.35);
      color: var(--green);
      font-size: clamp(18px, 2.3vw, 24px);
      line-height:1.7;
      width: min(640px, 100%);
    }
    .card{
      width:min(640px, 100%);
      margin: 0 auto;
      background: rgba(14,42,40,.55);
      border-radius: 22px;
      padding: 18px 16px 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }

    input{
      width: min(520px, 100%);
      padding: 14px 14px;
      border-radius: 14px;
      border: 0;
      outline: none;
      font-size: 18px;
      text-align:center;
      margin-top: 6px;
    }

    .hint{ margin: 10px 0 14px; color: var(--muted); font-size: 14px; }

    .btns{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    button{
      border:0;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 16px;
      cursor:pointer;
      background: var(--accent);
      color:#111;
      font-weight:700;
      min-width: 150px;
    }
    button.secondary{
      background: rgba(255,255,255,.12);
      color: #fff;
      border: 1px solid rgba(255,255,255,.18);
      font-weight:600;
    }
    button.danger{ background:#ef4444; color:#fff; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .timer{
      font-size: clamp(52px, 8vw, 78px);
      margin: 14px 0 8px;
      font-weight: 800;
      letter-spacing: 1px;
    }
    .footer{ margin-top: 10px; color: rgba(255,255,255,.65); font-size: 13px; }

    .adminBox{
      margin-top: 18px;
      text-align:right;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 14px;
    }
    .adminTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .adminTitle h3{ margin:0; font-size: 18px; }
    .pill{
      padding:6px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(34,197,94,.15);
      color: var(--green);
      border: 1px solid rgba(34,197,94,.35);
      white-space:nowrap;
    }
    .list{
      max-height: 260px;
      overflow:auto;
      padding: 10px;
      background: rgba(255,255,255,.06);
      border-radius: 12px;
      text-align:right;
    }
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 8px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 14px;
    }
    .row:last-child{border-bottom:0}
    .muted{color: rgba(255,255,255,.7)}
    .small{
      font-size:12px;
      color: rgba(255,255,255,.65);
      margin-top: 6px;
      text-align:right;
      line-height:1.6;
    }
    .err{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.35);
      color:#fecaca;
      text-align:right;
      font-size:13px;
      line-height:1.6;
      display:none;
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</h1>
    <p class="sub">Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© â€” Ø¥Ø´Ø±Ø§Ù Ù„Ø¬Ù†Ø© Ù…Ù†Ø§Ø¨Ø± Ø§Ù„Ù†ÙˆØ± Ø¨Ø§Ù„Ø¬ÙØ±</p>

    <div id="waitingMessage" class="waiting">
      â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…<br/>
      ğŸš¦ Ø§Ø³ØªØ¹Ø¯ÙˆØ§
    </div>

    <div class="card">
      <div id="playerUI">
        <input id="playerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙÙ‚Ø·" autocomplete="off" />
        <div class="hint">Ø§Ø¶ØºØ· <b>ØªØ³Ø¬ÙŠÙ„</b> Ø¨Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…</div>

        <div class="btns">
          <button id="joinBtn">ØªØ³Ø¬ÙŠÙ„</button>
        </div>

        <div class="timer" id="timer">00:00</div>
      </div>

      <div id="adminUI" style="display:none;">
        <div class="btns">
          <button id="adminStartBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
          <button class="secondary" id="adminStopBtn">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù / Ù…ØªØ§Ø¨Ø¹Ø©</button>
          <button class="danger" id="adminResetBtn">â™»ï¸ ØªØµÙÙŠØ±</button>
        </div>

        <div class="timer" id="adminTimer">00:00</div>

        <div class="adminBox">
          <div class="adminTitle">
            <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ­ÙƒÙ…</h3>
            <div class="pill" id="countPill">0 Ù…ØªØ³Ø§Ø¨Ù‚</div>
          </div>

          <div class="list" id="playersList"></div>
          <div class="err" id="errBox"></div>

          <div class="small">
            âœ… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªÙØ³Ø­Ø¨ Ù„Ø§ÙŠÙ Ù…Ù† Firestore.<br/>
            âœ… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ ÙŠØ±Ù‰ â€œØ¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…â€ ÙˆÙ„Ø§ ÙŠÙ‚Ø¯Ø± ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ù† Ø¬ÙˆØ§Ù„Ù‡.
          </div>
        </div>
      </div>

      <div class="footer">Â«Ø§Ù„Ù„Ù‡Ù… Ø§Ø±Ø²Ù‚Ù†Ø§ ØªÙˆÙÙŠÙ‚ Ø§Ù„Ø·Ø§Ø¹Ø©ØŒ ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹ØµÙŠØ©ØŒ ÙˆØµØ¯Ù‚ Ø§Ù„Ù†ÙŠØ©Â» â€” Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¯ (Ø¹)</div>
    </div>
  </div>

<script>
/* =========================
   1) Ø¶Ø¹ Firebase Config Ù‡Ù†Ø§ (Ø¶Ø±ÙˆØ±ÙŠ)
   ========================= */
const firebaseConfig = {
  apiKey: "PUT_YOUR_API_KEY_HERE",
  authDomain: "PUT_YOUR_AUTH_DOMAIN_HERE",
  projectId: "jawad-race",
  storageBucket: "PUT_YOUR_STORAGE_BUCKET_HERE",
  messagingSenderId: "PUT_YOUR_SENDER_ID_HERE",
  appId: "PUT_YOUR_APP_ID_HERE"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =========================
   2) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¨Ø§Ù‚
   ========================= */
const RACE_ID = "current";
const raceRef = db.collection("races").doc(RACE_ID);
const playersRef = db.collection("players");

const qs = new URLSearchParams(location.search);
const isAdmin = qs.get("admin") === "1";

/* =========================
   3) Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
   ========================= */
const waitingMessage = document.getElementById("waitingMessage");

const playerUI = document.getElementById("playerUI");
const adminUI  = document.getElementById("adminUI");

const playerName = document.getElementById("playerName");
const joinBtn = document.getElementById("joinBtn");
const timerEl = document.getElementById("timer");

const adminStartBtn = document.getElementById("adminStartBtn");
const adminStopBtn  = document.getElementById("adminStopBtn");
const adminResetBtn = document.getElementById("adminResetBtn");
const adminTimerEl = document.getElementById("adminTimer");

const playersList = document.getElementById("playersList");
const countPill = document.getElementById("countPill");
const errBox = document.getElementById("errBox");

/* =========================
   4) Ù…Ø¤Ù‚Øª Ù…Ø­Ù„ÙŠ
   ========================= */
let tickInterval = null;

function fmt(ms){
  const total = Math.max(0, Math.floor(ms/1000));
  const m = String(Math.floor(total/60)).padStart(2,"0");
  const s = String(total%60).padStart(2,"0");
  return `${m}:${s}`;
}
function stopTick(){
  if(tickInterval){ clearInterval(tickInterval); tickInterval = null; }
}
function startTick(startAtMs, paused){
  stopTick();
  const update = () => {
    if(paused) return;
    const diff = Date.now() - startAtMs;
    const t = fmt(diff);
    timerEl.textContent = t;
    adminTimerEl.textContent = t;
  };
  update();
  tickInterval = setInterval(update, 250);
}

/* =========================
   5) ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Admin/Player)
   ========================= */
if(isAdmin){
  playerUI.style.display = "none";
  adminUI.style.display  = "block";
} else {
  playerUI.style.display = "block";
  adminUI.style.display  = "none";
}

/* =========================
   6) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ (Ø¨Ø¯ÙˆÙ† Queries Ø¹Ø´Ø§Ù† Ù…Ø§ Ù†Ø­ØªØ§Ø¬ Index)
   ========================= */
function safeId(str){
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ ID Ø¢Ù…Ù† (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª/Ø±Ù…ÙˆØ²)
  return (str || "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, "_")
    .replace(/[^\u0600-\u06FFa-z0-9_]/g, "");
}

async function joinRace(){
  const name = (playerName.value || "").trim();
  if(name.length < 5){
    alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
    return;
  }

  joinBtn.disabled = true;

  const docId = `${RACE_ID}_${safeId(name)}`;
  const ref = playersRef.doc(docId);
  const snap = await ref.get();

  if(snap.exists){
    alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…");
    joinBtn.disabled = true;
    playerName.disabled = true;
    return;
  }

  try{
    await ref.set({
      name,
      raceId: RACE_ID,
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ… Ø§Ù†ØªØ¸Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…");
    joinBtn.disabled = true;
    playerName.disabled = true;
  }catch(e){
    console.error(e);
    alert("ØªØ¹Ø°Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ØºØ§Ù„Ø¨Ù‹Ø§ Rules ÙÙŠ Firestore ØªÙ…Ù†Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©.");
    joinBtn.disabled = false;
  }
}

joinBtn?.addEventListener("click", joinRace);
playerName?.addEventListener("keypress", (e)=>{ if(e.key==="Enter") joinRace(); });

/* =========================
   7) Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ­ÙƒÙ…: Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù„Ø§ÙŠÙ (Ø¨Ø¯ÙˆÙ† orderBy Ù„ØªÙØ§Ø¯ÙŠ Index)
   ========================= */
if(isAdmin){
  playersRef
    .where("raceId","==",RACE_ID)
    .onSnapshot((snap)=>{
      errBox.style.display = "none";
      const arr = [];
      snap.forEach(doc => arr.push({id: doc.id, ...doc.data()}));

      // ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª (Ù„Ùˆ joinedAt Ù…ÙˆØ¬ÙˆØ¯)
      arr.sort((a,b)=>{
        const ta = a.joinedAt?.toDate ? a.joinedAt.toDate().getTime() : 0;
        const tb = b.joinedAt?.toDate ? b.joinedAt.toDate().getTime() : 0;
        return ta - tb;
      });

      countPill.textContent = `${arr.length} Ù…ØªØ³Ø§Ø¨Ù‚`;
      playersList.innerHTML = arr.length ? "" : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯â€¦</div>`;

      arr.forEach((p, idx)=>{
        const joined = p.joinedAt?.toDate ? p.joinedAt.toDate() : null;
        const time = joined ? joined.toLocaleTimeString("ar-SA") : "--:--";
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `<div>${idx+1}) ${p.name}</div><div class="muted">${time}</div>`;
        playersList.appendChild(div);
      });
    }, (err)=>{
      console.error(err);
      errBox.style.display = "block";
      errBox.innerHTML = `âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Firestore: <br><span class="muted">${err.message}</span><br>âœ… Ø§ÙØ­Øµ Rules Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase config.`;
    });
}

/* =========================
   8) Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¨Ø§Ù‚ (ØªØµÙ„ Ù„Ù„ÙƒÙ„)
   ========================= */
raceRef.onSnapshot(async (doc)=>{
  if(!doc.exists){
    await raceRef.set({
      status: "waiting",
      paused: false,
      startAt: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return;
  }

  const data = doc.data();
  const status = data.status || "waiting";
  const paused = !!data.paused;

  if(status === "waiting"){
    waitingMessage.style.display = "block";
    stopTick();
    timerEl.textContent = "00:00";
    adminTimerEl.textContent = "00:00";
  }

  if(status === "running"){
    waitingMessage.style.display = "none";
    const startAt = data.startAt?.toDate ? data.startAt.toDate().getTime() : Date.now();
    startTick(startAt, paused);
  }
});

/* =========================
   9) Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ­ÙƒÙ…
   ========================= */
async function adminStart(){
  await raceRef.set({
    status: "running",
    paused: false,
    startAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminTogglePause(){
  const doc = await raceRef.get();
  const paused = !!doc.data()?.paused;
  await raceRef.set({
    paused: !paused,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

async function adminReset(){
  await raceRef.set({
    status: "waiting",
    paused: false,
    startAt: null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

if(isAdmin){
  adminStartBtn.addEventListener("click", adminStart);
  adminStopBtn.addEventListener("click", adminTogglePause);
  adminResetBtn.addEventListener("click", adminReset);
}
</script>

</body>
</html>
