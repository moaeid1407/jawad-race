<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</title>
  <style>
    body{font-family:system-ui,Tahoma;background:#f6f7fb;margin:0;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;margin:auto;max-width:560px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    h1{margin:0 0 8px 0}
    input,button{width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;font-size:16px;margin-top:8px}
    button{cursor:pointer}
    .opt{background:#f1f5f9;margin-top:10px;text-align:right}
    .opt:hover{background:#e2e8f0}
    .ok{color:#16a34a;font-weight:800}
    .err{color:#dc2626;font-weight:800}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;color:#555;white-space:pre-wrap}
    .muted{color:#666}
  </style>
</head>
<body>
<div class="card">
  <h1>ğŸ Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¬ÙˆØ§Ø¯ â€” Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</h1>
  <div class="muted">Ø³Ø¬Ù‘Ù„ Ø§Ø³Ù…Ùƒ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª.</div>

  <input id="nameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
  <button id="joinBtn" type="button">ØªØ³Ø¬ÙŠÙ„</button>
  <button id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø§Ø³Ù…</button>

  <div id="raceStatus" class="mono" style="margin-top:10px">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¨Ø§Ù‚â€¦</div>
  <div id="msg" style="margin-top:8px"></div>

  <hr style="margin:14px 0">

  <h3 id="questionText">â€”</h3>
  <div id="options"></div>
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
    authDomain: "jawad-race.firebaseapp.com",
    projectId: "jawad-race",
    storageBucket: "jawad-race.firebasestorage.app",
    messagingSenderId: "677185572718",
    appId: "1:677185572718:web:91c4674236efce1d6efb7f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp,
    query, where, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const raceRef      = doc(db, "race", "current");
  const questionsCol = collection(db, "questions");
  const playersCol   = collection(db, "players");
  const answersCol   = collection(db, "answers");

  const $ = (id)=>document.getElementById(id);
  const msg = (t, cls="") => { $("msg").innerHTML = `<div class="${cls}">${t}</div>`; };

  const LS = "jr_player_name";
  const getName = ()=>localStorage.getItem(LS)||"";
  const setName = (v)=>localStorage.setItem(LS,v);
  const clearName = ()=>localStorage.removeItem(LS);

  let currentQuestionId = null;
  let questionShownAt   = null;

  function renderName(){
    const n = getName();
    $("nameInput").value = n || "";
  }
  renderName();

  $("joinBtn").onclick = async()=>{
    const name = $("nameInput").value.trim();
    if(!name){ msg("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ","err"); return; }
    try{
      await addDoc(playersCol, { name, createdAt: serverTimestamp() });
      setName(name);
      msg("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„","ok");
    }catch(e){
      msg("âŒ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: "+(e?.message||e),"err");
    }
  };

  $("clearBtn").onclick = ()=>{
    clearName();
    $("nameInput").value="";
    msg("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø§Ø³Ù…");
  };

  async function alreadyAnswered(qid){
    const name = getName();
    if(!name) return false;
    const qy = query(answersCol, where("questionId","==", qid), where("playerName","==", name), limit(1));
    const s = await getDocs(qy);
    return !s.empty;
  }

  async function submitAnswer(qid, optionText, optionIndex){
    const name = getName();
    if(!name){ msg("âŒ Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ù‹Ø§","err"); return; }

    const timeMs = questionShownAt ? Math.max(0, Date.now() - questionShownAt) : null;

    await addDoc(answersCol,{
      questionId: qid,
      playerName: name,
      optionText,
      optionIndex,
      timeMs,
      createdAt: serverTimestamp()
    });

    msg("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©","ok");
    // Ø§Ù‚ÙÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    [...$("options").querySelectorAll("button")].forEach(b=>b.disabled=true);
  }

  function renderOptions(q){
    $("options").innerHTML = "";

    const opts = Array.isArray(q.options) ? q.options : [];
    if(!opts.length){
      msg("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø®ÙŠØ§Ø±Ø§Øª (options). Ø§Ø³ØªÙˆØ±Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†.","err");
      return;
    }

    opts.forEach((opt,i)=>{
      const b = document.createElement("button");
      b.type="button";
      b.className="opt";
      b.textContent = `(${i+1}) ${opt}`;
      b.onclick = ()=>submitAnswer(currentQuestionId, String(opt), i);
      $("options").appendChild(b);
    });
  }

  let unsubQ = null;
  const safeUnsub = (fn)=>{ try{ fn && fn(); }catch(_){} };

  onSnapshot(raceRef, (snap)=>{
    if(!snap.exists()) return;

    const r = snap.data();
    $("raceStatus").textContent = `status=${r.status||"-"} | index=${r.questionIndex ?? "-"}`;

    if(!r.activeQuestionId){
      $("questionText").textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„â€¦";
      $("options").innerHTML = "";
      return;
    }

    const qid = r.activeQuestionId;
    if(qid === currentQuestionId) return;

    currentQuestionId = qid;
    questionShownAt = Date.now();
    msg("");

    safeUnsub(unsubQ);
    unsubQ = onSnapshot(doc(db,"questions",qid), async(qsnap)=>{
      if(!qsnap.exists()){
        $("questionText").textContent = "âŒ Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        $("options").innerHTML = "";
        msg("Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ø¶ØºØ· (ØªØµÙÙŠØ±) Ø£Ùˆ Ø§Ø³ØªÙˆØ±Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù‚Ø§Ù„Ø¨ ØµØ­ÙŠØ­.","err");
        return;
      }

      const q = qsnap.data();
      $("questionText").textContent = q.text || q.question || "â€”";
      questionShownAt = Date.now();

      renderOptions(q);

      try{
        if(await alreadyAnswered(qid)){
          msg("âœ… Ø£Ù†Øª Ø¬Ø§ÙˆØ¨Øª Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§.","ok");
          [...$("options").querySelectorAll("button")].forEach(b=>b.disabled=true);
        }
      }catch(_){}
    });
  });
</script>
</body>
</html>
