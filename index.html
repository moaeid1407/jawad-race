<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>سباق الإمام الجواد عليه السلام</title>

  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#071c1b;
      color:#fff;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:30px 14px;
    }
    .wrap{width:min(760px,100%);text-align:center}
    h1{margin:10px 0;font-size:36px}
    .sub{color:rgba(255,255,255,.7)}
    .waiting{
      border:2px dashed #22c55e;
      border-radius:16px;
      padding:16px;
      margin:20px auto;
      color:#22c55e;
      font-size:20px;
    }
    .card{
      background:rgba(14,42,40,.55);
      border-radius:20px;
      padding:18px;
      margin:auto;
    }
    input{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:0;
      font-size:18px;
      text-align:center;
    }
    button{
      margin-top:12px;
      padding:12px 20px;
      border-radius:12px;
      border:0;
      background:#f59e0b;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
    }
    .timer{
      font-size:64px;
      margin:16px 0;
      font-weight:bold;
    }
    .adminBox{
      margin-top:20px;
      background:rgba(0,0,0,.2);
      padding:14px;
      border-radius:14px;
      text-align:right;
    }
    .row{
      display:flex;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.15);
      padding:6px 0;
      font-size:14px;
    }
  </style>

  <!-- Firebase compat (متوافق مع الكود) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="wrap">
  <h1>سباق الإمام الجواد عليه السلام</h1>
  <p class="sub">مسابقة تفاعلية — لجنة منابر النور بالجفر</p>

  <div id="waiting" class="waiting">⏳ بانتظار بدء السباق من المنظم</div>

  <div class="card">
    <div id="playerUI">
      <input id="nameInput" placeholder="اكتب اسمك الثلاثي" />
      <button id="joinBtn">تسجيل</button>
      <div class="timer" id="timer">00:00</div>
    </div>

    <div id="adminUI" style="display:none">
      <button onclick="startRace()">▶️ بدء السباق</button>
      <button onclick="resetRace()">♻️ تصفير</button>
      <div class="timer" id="adminTimer">00:00</div>

      <div class="adminBox">
        <h3>المتسابقون</h3>
        <div id="players"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= Firebase Config ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCXRjGFao0aRxTU1zPnM80-I7NW5YP-yBM",
  authDomain: "jawad-race.firebaseapp.com",
  projectId: "jawad-race",
  storageBucket: "jawad-race.firebasestorage.app",
  messagingSenderId: "677185572718",
  appId: "1:677185572718:web:91c4674236efce1d6efb7f"
});

const db = firebase.firestore();

/* ================= إعدادات ================= */
const RACE_ID = "current";
const raceRef = db.collection("races").doc(RACE_ID);
const playersRef = db.collection("players");

const isAdmin = new URLSearchParams(location.search).get("admin")==="1";

/* ================= واجهة ================= */
const waiting = document.getElementById("waiting");
const playerUI = document.getElementById("playerUI");
const adminUI  = document.getElementById("adminUI");
const timer = document.getElementById("timer");
const adminTimer = document.getElementById("adminTimer");
const playersDiv = document.getElementById("players");

if(isAdmin){
  playerUI.style.display="none";
  adminUI.style.display="block";
}

/* ================= تسجيل لاعب ================= */
document.getElementById("joinBtn").onclick = async ()=>{
  const name = document.getElementById("nameInput").value.trim();
  if(name.length<5){alert("اكتب الاسم الثلاثي");return;}

  await playersRef.add({
    name,
    raceId:RACE_ID,
    joinedAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("تم التسجيل");
};

/* ================= عرض اللاعبين (Admin) ================= */
if(isAdmin){
  playersRef.where("raceId","==",RACE_ID)
    .orderBy("joinedAt")
    .onSnapshot(snap=>{
      playersDiv.innerHTML="";
      snap.forEach((d,i)=>{
        playersDiv.innerHTML+=
          `<div class="row"><span>${i+1}) ${d.data().name}</span></div>`;
      });
    });
}

/* ================= السباق ================= */
let interval=null;
function runTimer(start){
  clearInterval(interval);
  interval=setInterval(()=>{
    const diff=Date.now()-start;
    const m=String(Math.floor(diff/60000)).padStart(2,"0");
    const s=String(Math.floor(diff/1000)%60).padStart(2,"0");
    timer.textContent=adminTimer.textContent=`${m}:${s}`;
  },500);
}

raceRef.onSnapshot(async doc=>{
  if(!doc.exists){
    await raceRef.set({status:"waiting",startAt:null});
    return;
  }
  const d=doc.data();
  if(d.status==="waiting"){
    waiting.style.display="block";
    timer.textContent=adminTimer.textContent="00:00";
    clearInterval(interval);
  }
  if(d.status==="running"){
    waiting.style.display="none";
    runTimer(d.startAt.toDate().getTime());
  }
});

/* ================= أزرار المتحكم ================= */
function startRace(){
  raceRef.set({
    status:"running",
    startAt:firebase.firestore.FieldValue.serverTimestamp()
  });
}
function resetRace(){
  raceRef.set({status:"waiting",startAt:null});
}
</script>
</body>
</html>
